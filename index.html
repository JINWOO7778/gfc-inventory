<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì§€ì—í”„ì”¨ìƒëª…ê³¼í•™ ì¬ê³  ê´€ë¦¬ (Realtime + ì¦‰ì‹œ íˆìŠ¤í† ë¦¬ ë°˜ì˜)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand-primary:#006d77; --brand-secondary:#83c5be; --brand-bg:#edf6f9;
      --gap:14px; --border:#e6e9ef; --muted:#5f6b7a; --bg:#f7fafc; --card:#fff;
      --thead:#eaf1ff; --thead-text:#0e1a2b; --row-hover:#f3f6fb; --text:#111825;
      --danger:#ef4444; --danger-600:#dc2626; --ok:#10b981; --ok-600:#059669;
      --shadow:0 1px 2px rgba(16,24,40,.06),0 1px 3px rgba(16,24,40,.1);
    }
    *{box-sizing:border-box;} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);}
    header{padding:10px 16px;border-bottom:1px solid var(--border);background:var(--card);position:sticky;top:0;z-index:30;display:flex;flex-direction:column;gap:10px;box-shadow:var(--shadow);}
    .topline{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .logo-area{display:flex;align-items:center;gap:10px;font-weight:600;color:var(--brand-primary);} .logo{height:32px;object-fit:contain;}
    .csv-actions{display:flex;gap:10px;align-items:center;}
    .csv-actions button{padding:8px 12px;font-size:13px;border-radius:8px;background:var(--brand-primary);color:#fff;border:none;cursor:pointer;display:flex;gap:6px;align-items:center;}
    .csv-actions button:hover{background:var(--brand-secondary);} .csv-actions input[type="file"]{display:none;}
    .statusbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;font-size:12px;padding:8px 10px;border:1px dashed var(--border);border-radius:8px;background:#fafafa;}
    .pill{padding:2px 8px;border-radius:999px;font-weight:600;font-size:11px;border:1px solid #d1d5db;background:#fff;}
    .pill-auth{background:#e8f0fe;border-color:#c6dafc;color:#1a73e8;}
    .pill-online{background:#e6f4ea;border-color:#bbdfc8;color:#156d3a;}
    .pill-offline{background:#fff4d6;border-color:#ffe08a;color:#8a5a00;}
    .pill-error{background:#fde8e8;border-color:#f5b1b1;color:#b91c1c;}
    main{padding:20px;display:grid;gap:24px;max-width:1200px;margin:0 auto;}
    .card{border:1px solid var(--border);border-radius:12px;background:var(--card);box-shadow:var(--shadow);} 
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:16px;background:#f9fafb;font-weight:600;}
    .card .body{padding:16px;} .hint{font-size:12px;color:#6b7280;margin-top:4px;}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:var(--gap);align-items:start;}
    .field label{display:block;margin-bottom:6px;color:#374151;font-size:13px;font-weight:500;}
    .field input,.field select,.field textarea{width:100%;padding:9px 11px;border:1px solid var(--border);border-radius:8px;background:#fff;font-size:14px;outline:none;transition:.15s;}
    .field input:focus,.field select:focus,.field textarea:focus{box-shadow:0 0 0 2px rgba(37,99,235,.2);border-color:#2563eb;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;}
    .btn{cursor:pointer;font-size:14px;transition:.15s;border-radius:8px;padding:9px 14px;border:1px solid var(--border);background:#fff;}
    .btn-primary{background:var(--brand-primary);border:none;color:#fff;} .btn-primary:hover{background:var(--brand-secondary);} .btn-primary[disabled]{opacity:.6;cursor:not-allowed;}
    .btn-ghost:hover{background:#f3f4f6;} .btn-danger{background:var(--danger);border:none;color:#fff;} .btn-danger:hover{background:var(--danger-600);}
    .btn-ok{background:var(--ok);border:none;color:#fff;} .btn-ok:hover{background:var(--ok-600);}
    .table-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:10px;background:#fff;}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:1000px;}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle;font-size:13px;}
    thead th{background:var(--thead);color:var(--thead-text);font-weight:600;}
    tbody tr:hover{background:var(--row-hover);} td.num,th.num{text-align:right;}
    th.sortable{cursor:pointer;user-select:none;} th.sortable .sort-ind{margin-left:4px;opacity:.65;font-size:11px;}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);padding:20px;z-index:50;}
    .modal.open{display:flex;} .dialog{width:min(960px,100%);max-height:95vh;background:#fff;border-radius:12px;overflow:hidden;border:1px solid var(--border);display:flex;flex-direction:column;box-shadow:0 8px 24px rgba(0,0,0,.12);}
    .modal .head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);background:#f9fafb;position:sticky;top:0;z-index:1;}
    .modal .content{padding:16px;overflow-y:auto;}
    #subLabCustomWrap{display:none;}
    .errorline{font-size:12px;color:#b91c1c;display:none;}
  </style>
</head>
<body>
<header>
  <div class="topline">
    <div class="logo-area"><img src="ì§€ì—í”„ì”¨-ë¡œê³  PNG.png" class="logo" alt="GFC"/><span>ì§€ì—í”„ì”¨ìƒëª…ê³¼í•™ ì¬ê³  ê´€ë¦¬</span></div>
    <div class="csv-actions">
      <button id="btnExportXLSX">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
      <input type="file" id="fileInputXLSX" accept=".xlsx,.xls" />
      <button id="btnImportXLSX">ğŸ“¥ ì—…ë¡œë“œ</button>
    </div>
  </div>
  <div class="statusbar">
    <span class="pill pill-auth" id="authPill">Auth: í™•ì¸ì¤‘</span>
    <span class="pill pill-offline" id="syncPill">Sync: ëŒ€ê¸°</span>
    <span id="statusMsg" style="color:#6b7280;">ì¸ì¦ ë° Firestore ì—°ê²° ì¤€ë¹„ ì¤‘â€¦</span>
    <button class="btn btn-ghost" id="btnRetry" style="margin-left:auto;display:none;">ì¬ì‹œë„</button>
  </div>
</header>

<main>
  <section class="card">
    <h2>ğŸ” ê²€ìƒ‰</h2>
    <div class="body">
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <input type="text" id="searchInput" placeholder="í’ˆëª©ëª…, ì—°êµ¬ì†Œ, Lab, ìœ„ì¹˜, ì œì¡°ì‚¬, Cat#, ë‹¨ìœ„ ë“± ê²€ìƒ‰ (ì—¬ëŸ¬ ë‹¨ì–´ ê³µë°± AND)" style="flex:1 1 260px;"/>
        <button class="btn btn-ghost" id="btnClearSearch">ì§€ìš°ê¸°</button>
      </div>
    </div>
  </section>

  <section class="card" id="section-create">
    <h2>â• í’ˆëª© ë“±ë¡ <span class="pill" id="editBadge" style="display:none;">âœ ìˆ˜ì • ëª¨ë“œ</span></h2>
    <div class="body">
      <div class="form-grid">
        <div class="field"><label for="name">í’ˆëª©ëª… *</label><input id="name" placeholder="í•„ìˆ˜"/></div>
        <div class="field"><label for="manufacturer">ì œì¡°ì‚¬</label><input id="manufacturer"/></div>
        <div class="field"><label for="catalog">Cat#</label><input id="catalog"/></div>
        <div class="field"><label for="topLab">ìƒìœ„ì—°êµ¬ì†Œ</label>
          <select id="topLab">
            <option value="">ì „ì²´ê³µìš©</option>
            <option value="GBC ì—°êµ¬ì†Œ">GBC ì—°êµ¬ì†Œ</option>
            <option value="HMC ì—°êµ¬ì†Œ">HMC ì—°êµ¬ì†Œ</option>
            <option value="RNA ì¹˜ë£Œì œ ì—°êµ¬ì†Œ">RNA ì¹˜ë£Œì œ ì—°êµ¬ì†Œ</option>
            <option value="ì˜ë£Œê¸°ê¸°-ë™íƒ„1ê³µì¥">ì˜ë£Œê¸°ê¸°-ë™íƒ„1ê³µì¥</option>
          </select>
          <div class="hint">* ì˜ë£Œê¸°ê¸° ì„ íƒ ì‹œ í•˜ìœ„Labì„ ì„ íƒí•˜ê±°ë‚˜ <b>ê¸°íƒ€(ì§ì ‘ì…ë ¥)</b>ìœ¼ë¡œ ì…ë ¥í•  ìˆ˜ ìˆì–´ìš”.</div>
        </div>
        <div class="field"><label for="subLab">í•˜ìœ„Lab</label>
          <select id="subLab"></select>
          <div id="subLabCustomWrap" class="hint"><input id="subLabCustom" placeholder="ì§ì ‘ ì…ë ¥ (ì˜ˆ: ì„±í˜•ì‹¤Bë™)"/></div>
          <div class="hint">* ì„ íƒí•˜ì§€ ì•Šì•„ë„ ë“±ë¡ ê°€ëŠ¥. ë¯¸ì§€ì • ì‹œ ê³µë€ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
        </div>
        <div class="field"><label for="location">ìœ„ì¹˜</label><input id="location" placeholder="ì˜ˆ: ëƒ‰ë™ê³  A-3"/></div>
        <div class="field"><label for="qty">í˜„ì¬ê³ </label><input type="number" id="qty" value="0"/></div>
        <div class="field"><label for="unit">ë‹¨ìœ„</label><input id="unit" placeholder="EA, Box, g, mL ë“±"/></div>
        <div class="field"><label for="price">ë‹¨ê°€(ì›)</label><input type="number" id="price" value="0"/></div>
        <div class="field"><label for="stockDate">ì¬ê³  í™•ì¸ ë‚ ì§œ</label><input type="date" id="stockDate"/></div>
        <div class="field"><label for="createdAt">ë“±ë¡ ë‚ ì§œ</label><input type="date" id="createdAt"/></div>
      </div>
      <div class="errorline" id="formError"></div>
      <div class="actions" style="margin-top:14px;">
        <button class="btn btn-ghost" id="btnReset">í¼ ì´ˆê¸°í™”</button>
        <button class="btn btn-primary" id="btnApply" disabled>ì ìš©</button>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>ğŸ“‹ í’ˆëª© ëª©ë¡</h2>
    <div class="body">
      <div class="table-wrap">
        <table id="itemsTable">
          <thead><tr>
            <th>ì‘ì—…</th>
            <th class="sortable" data-sort="name">í’ˆëª©ëª…<span class="sort-ind" id="ind-name"></span></th>
            <th>ì œì¡°ì‚¬</th><th>Cat#</th>
            <th class="sortable" data-sort="topLab">ìƒìœ„ì—°êµ¬ì†Œ<span class="sort-ind" id="ind-topLab"></span></th>
            <th class="sortable" data-sort="subLab">í•˜ìœ„Lab<span class="sort-ind" id="ind-subLab"></span></th>
            <th>ìœ„ì¹˜</th><th class="num">í˜„ì¬ì¬ê³ ëŸ‰</th><th class="num">ë‹¨ê°€(ì›)</th><th>ì¬ê³  í™•ì¸ ë‚ ì§œ</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<div class="modal" id="detailModal" aria-hidden="true">
  <div class="dialog">
    <div class="head">
      <h3 id="detailTitle">ì…ì¶œê³  ìƒì„¸</h3>
      <div class="actions">
        <button class="btn btn-ghost" id="btnExportHistoryCSV">íˆìŠ¤í† ë¦¬ ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-danger" id="btnDelete">ì‚­ì œ</button>
        <button class="btn btn-ghost" id="btnClose">ë‹«ê¸°</button>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <h2>ì…ì¶œê³  ê´€ë¦¬</h2>
        <div class="body">
          <div class="form-grid">
            <div class="field"><label for="t_qty">ìˆ˜ëŸ‰(+/-)</label><input type="number" id="t_qty" placeholder="+10 ë˜ëŠ” -5"/></div>
            <div class="field"><label for="t_date">ê±°ë˜ ë‚ ì§œ</label><input type="date" id="t_date"/></div>
            <div class="field"><label for="t_price">ê°€ê²©(ì›, ì…ê³  ì‹œ)</label><input type="number" id="t_price" placeholder="ì…ê³ ì¼ ë•Œë§Œ"/></div>
            <div class="field"><label for="t_user">ì‚¬ìš©ì</label><input id="t_user" placeholder="ì¶œê³  ë‹´ë‹¹ì/ì‚¬ìš©ì"/></div>
            <div class="field" style="grid-column:1/-1;"><label for="t_note">ë¹„ê³ </label><textarea id="t_note" placeholder="ê±°ë˜ ê´€ë ¨ ë©”ëª¨"></textarea></div>
          </div>
          <div class="actions" style="margin-top:12px;">
            <button class="btn btn-ok" id="btnInbound">ì…ê³ </button>
            <button class="btn btn-primary" id="btnOutbound">ì¶œê³ </button>
          </div>
          <div style="margin-top:20px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <h3 style="margin:0;font-size:15px;">ğŸ“œ íˆìŠ¤í† ë¦¬</h3>
              <button class="btn btn-ghost" id="btnCopyHistory" style="margin-left:auto;">ë³µì‚¬</button>
            </div>
            <div class="table-wrap" style="margin-top:8px;">
              <table id="historyTable">
                <thead><tr><th>ë‚ ì§œ</th><th class="num">ìˆ˜ëŸ‰(+/-)</th><th>ë¹„ê³ </th><th class="num">ê°€ê²©(ì›)</th><th>ì‚¬ìš©ì</th><th>ê¸°ë¡ì‹œê°</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:"AIzaSyCTn9uq5vSbAn8SnxIlG_AwXvvz8_Is5R4",
    authDomain:"gfc-inventory.firebaseapp.com",
    projectId:"gfc-inventory",
    storageBucket:"gfc-inventory.firebasestorage.app",
    messagingSenderId:"402572923133",
    appId:"1:402572923133:web:7a8bcbd02d2ce23939ee94"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const nf = new Intl.NumberFormat('ko-KR');
  const storeKey = 'inv_items_cache_realtime_v2';
  const $ = s=>document.querySelector(s);
  const todayStr = () => new Date().toISOString().slice(0,10);

  let items = [];
  let currentId = null;
  let unsubscribe = null;
  let authed = false;

  const authPill = $('#authPill'); const syncPill = $('#syncPill'); const statusMsg = $('#statusMsg'); const btnRetry = $('#btnRetry');

  function setAuthPill(text){ authPill.textContent = 'Auth: ' + text; }
  function setSyncPill(kind, text){ syncPill.textContent = 'Sync: ' + (text || kind); syncPill.className='pill ' + (kind==='Online'?'pill-online':kind==='Error'?'pill-error':'pill-offline'); }
  function showErrorLine(msg){ const el=$('#formError'); el.style.display='block'; el.textContent=msg||''; }
  function clearErrorLine(){ const el=$('#formError'); el.style.display='none'; el.textContent=''; }

  const CUSTOM_TOKEN="__CUSTOM__";
  const subLabMap = {
    "": ["ë¯¸ì§€ì •"],
    "GBC ì—°êµ¬ì†Œ": ["ë§ˆì´í¬ë¡œë°”ì´ì˜´Lab","ìœµí•©ê¸°ìˆ  Lab","ì¬ìƒë°”ì´ì˜¤ Lab"],
    "HMC ì—°êµ¬ì†Œ": ["í™œì„±ì—°êµ¬ Lab","ì‹ë¬¼ì„¸í¬ì—°êµ¬Lab","ì œí˜•ì—°êµ¬Lab","ì‹ ì†Œì¬ì—°êµ¬ Lab"],
    "RNA ì¹˜ë£Œì œ ì—°êµ¬ì†Œ": ["RNA Lab"],
    "ì˜ë£Œê¸°ê¸°-ë™íƒ„1ê³µì¥": ["ë¬´ê· ì‹¤","ì„±í˜•ì‹¤","ì¡°ë¦½ì‹¤","ë©¸ê· /í¬ì¥","QA/QC","ì°½ê³ ","ê³µì •ê°œë°œ","ìƒì‚°1ë¼ì¸","ìƒì‚°2ë¼ì¸"]
  };
  function populateSubLab(selectEl, topLabValue, currentValue){
    const base = subLabMap[topLabValue || ""] || ["ë¯¸ì§€ì •"];
    const opts = ["ë¯¸ì§€ì •", ...base, "ê¸°íƒ€(ì§ì ‘ì…ë ¥)"];
    selectEl.innerHTML = '';
    opts.forEach(name=>{
      const o=document.createElement('option');
      if(name==="ê¸°íƒ€(ì§ì ‘ì…ë ¥)") o.value=CUSTOM_TOKEN;
      else if(name==="ë¯¸ì§€ì •") o.value="";
      else o.value=name;
      o.textContent = name; selectEl.appendChild(o);
    });
    if(currentValue===undefined||currentValue===null) currentValue="";
    if(currentValue && !opts.includes(currentValue)){
      selectEl.value=CUSTOM_TOKEN; $('#subLabCustomWrap').style.display='block'; $('#subLabCustom').value=currentValue;
    }else{
      selectEl.value=currentValue||""; $('#subLabCustomWrap').style.display='none'; $('#subLabCustom').value='';
    }
  }
  function readSubLabValue(){ return (f.subLab.value===CUSTOM_TOKEN) ? (f.subLabCustom.value||'').trim() : (f.subLab.value||""); }

  const f = {
    name:$('#name'), manufacturer:$('#manufacturer'), catalog:$('#catalog'),
    topLab:$('#topLab'), subLab:$('#subLab'), subLabCustom:$('#subLabCustom'),
    location:$('#location'), qty:$('#qty'), unit:$('#unit'), price:$('#price'),
    stockDate:$('#stockDate'), createdAt:$('#createdAt'),
    btnReset:$('#btnReset'), btnApply:$('#btnApply'),
    searchInput:$('#searchInput'), btnClearSearch:$('#btnClearSearch'),
    editBadge:$('#editBadge')
  };

  const d = {
    modal:$('#detailModal'), title:$('#detailTitle'),
    btnDelete:$('#btnDelete'), btnClose:$('#btnClose'),
    t_qty:$('#t_qty'), t_date:$('#t_date'), t_price:$('#t_price'),
    t_user:$('#t_user'), t_note:$('#t_note'),
    btnInbound:$('#btnInbound'), btnOutbound:$('#btnOutbound'),
    btnCopyHistory:$('#btnCopyHistory'), btnExportHistoryCSV:$('#btnExportHistoryCSV')
  };

  let sortKey=null, sortDir='asc';

  function normalize(v){ return (v ?? '').toString().toLowerCase().trim(); }
  function getSearchableText(x){
    return [x.name,x.topLab,x.subLab,x.location,x.manufacturer,x.catalog,x.unit,x.qty,x.price,x.stockDate,x.createdAt]
      .map(v=>normalize(v)).join(' ');
  }
  function getViewList(){
    const raw=normalize(f.searchInput?.value||'');
    if(!raw) return items.slice();
    const tokens=raw.split(/\s+/).filter(Boolean);
    return items.filter(x=>tokens.every(tok=>getSearchableText(x).includes(tok)));
  }
  function applySort(list){
    if(!sortKey) return list;
    const dir = (sortDir==='asc')?1:-1;
    return list.sort((a,b)=> (a[sortKey]??'').toString().localeCompare((b[sortKey]??'').toString(), undefined, {numeric:true,sensitivity:'base'}) * dir );
  }
  function updateSortIndicators(){
    const inds={name:$('#ind-name'), topLab:$('#ind-topLab'), subLab:$('#ind-subLab')};
    Object.values(inds).forEach(el=>{ if(el) el.textContent=''; });
    if(sortKey && inds[sortKey]) inds[sortKey].textContent = (sortDir==='asc')?'â–²':'â–¼';
  }
  const tbody = document.querySelector('#itemsTable tbody');
  function renderItems(){
    const list = applySort(getViewList());
    tbody.innerHTML='';
    list.forEach(item=>{
      const tr=document.createElement('tr');
      const tdAct=document.createElement('td');
      const b1=document.createElement('button'); b1.textContent='ìƒì„¸'; b1.className='btn btn-ghost'; b1.onclick=()=>openDetail(item.id);
      const b2=document.createElement('button'); b2.textContent='í¸ì§‘'; b2.className='btn btn-ghost'; b2.style.marginLeft='6px'; b2.onclick=()=>editItem(item.id);
      tdAct.append(b1,b2);
      const tdName=document.createElement('td'); tdName.textContent=item.unit?`${item.name} (${item.unit})`:item.name||'';
      const tdManu=document.createElement('td'); tdManu.textContent=item.manufacturer||'';
      const tdCat=document.createElement('td'); tdCat.textContent=item.catalog||'';
      const tdTop=document.createElement('td'); tdTop.textContent=item.topLab||'';
      const tdSub=document.createElement('td'); tdSub.textContent=item.subLab||'';
      const tdLoc=document.createElement('td'); tdLoc.textContent=item.location||'';
      const tdQty=document.createElement('td'); tdQty.className='num'; tdQty.textContent = nf.format(Number(item.qty||0));
      const tdPrice=document.createElement('td'); tdPrice.className='num'; tdPrice.textContent = nf.format(Number(item.price||0));
      const tdSD=document.createElement('td'); tdSD.textContent=item.stockDate||'';
      tr.append(tdAct,tdName,tdManu,tdCat,tdTop,tdSub,tdLoc,tdQty,tdPrice,tdSD); tbody.appendChild(tr);
    });
    updateSortIndicators();
  }

  function openModal(){ d.modal.classList.add('open'); d.modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ d.modal.classList.remove('open'); d.modal.setAttribute('aria-hidden','true'); currentId=null; }
  function renderHistory(item){
    const hb=document.querySelector('#historyTable tbody'); hb.innerHTML='';
    (item.history||[]).slice().sort((a,b)=>(a.ts||0)-(b.ts||0)).forEach(h=>{
      const tr=document.createElement('tr');
      const tdDate=document.createElement('td'); tdDate.textContent = h.date || '';
      const tdDelta=document.createElement('td'); tdDelta.className='num'; tdDelta.textContent = nf.format(Number(h.delta ?? 0));
      const tdNote=document.createElement('td'); tdNote.textContent = h.note || '';
      const tdPrice=document.createElement('td'); tdPrice.className='num'; tdPrice.textContent = h.price!=null ? nf.format(Number(h.price)) : '';
      const tdUser=document.createElement('td'); tdUser.textContent = h.user || '';
      const tdTS=document.createElement('td'); tdTS.textContent = new Date(h.ts || Date.now()).toLocaleString();
      tr.append(tdDate,tdDelta,tdNote,tdPrice,tdUser,tdTS); hb.appendChild(tr);
    });
  }
  function openDetail(id){
    const item=items.find(x=>x.id===id); if(!item) return;
    currentId=id; d.title.textContent=`ì…ì¶œê³  ìƒì„¸ - ${item.name}`;
    d.t_qty.value=''; d.t_date.value=''; d.t_price.value=''; d.t_user.value=''; d.t_note.value='';
    renderHistory(item); openModal();
  }

  function resetMainForm(){
    f.name.value=''; f.manufacturer.value=''; f.catalog.value='';
    f.topLab.value=''; populateSubLab(f.subLab,''); f.subLab.value=''; $('#subLabCustomWrap').style.display='none'; f.subLabCustom.value='';
    f.location.value=''; f.qty.value='0'; f.unit.value=''; f.price.value='0';
    f.stockDate.value=''; f.createdAt.value='';
    currentId=null; f.editBadge.style.display='none'; clearErrorLine();
  }
  function validateMainForm(){
    if(!(f.name.value||'').trim()){ showErrorLine('í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return false; }
    if(f.subLab.value===CUSTOM_TOKEN && !(f.subLabCustom.value||'').trim()){
      if(!confirm('í•˜ìœ„Labì„ ì§ì ‘ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¯¸ì§€ì •ìœ¼ë¡œ ë“±ë¡í• ê¹Œìš”?')) return false;
    }
    clearErrorLine(); return true;
  }
  function formToRecord(idIfAny){
    return {
      id: idIfAny || crypto.randomUUID(),
      name:(f.name.value||'').trim(),
      manufacturer:(f.manufacturer.value||'').trim(),
      catalog:(f.catalog.value||'').trim(),
      topLab:f.topLab.value||'',
      subLab: readSubLabValue(),
      location:(f.location.value||'').trim(),
      qty:Number(f.qty.value||0),
      unit:(f.unit.value||'').trim(),
      price:Number(f.price.value||0),
      stockDate:f.stockDate.value||todayStr(),
      createdAt:f.createdAt.value||todayStr(),
      history: []
    };
  }

  function persistLocal(){ localStorage.setItem(storeKey, JSON.stringify(items)); }

  async function createOrUpdate(){
    if(!validateMainForm()) return;
    try{
      if(currentId){
        const base = formToRecord(currentId);
        // ìˆ˜ì • ì‹œ ê¸°ì¡´ ì…ì¶œê³  ë‚´ì—­(history)ì„ ë®ì–´ì“°ì§€ ì•Šë„ë¡ ì œì™¸
        delete base.history;
        await setDoc(doc(db,'items',currentId), base, {merge:true});
        alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }else{
        const rec = formToRecord();
        await setDoc(doc(db,'items',rec.id), rec, {merge:true});
        alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
      clearErrorLine(); resetMainForm();
    }catch(e){
      console.error(e);
      showErrorLine('ì„œë²„ ì €ì¥ ì‹¤íŒ¨: ' + (e?.message || e));
      if(currentId){
        const idx = items.findIndex(x=>x.id===currentId);
        if(idx>=0){
          const patch = formToRecord(currentId);
          delete patch.history; // ë¡œì»¬ì—ì„œë„ history ë³´ì¡´
          items[idx] = {...items[idx], ...patch};
        }
      }else{
        const rec = formToRecord(); items.push(rec);
      }
      persistLocal(); renderItems();
      alert('ë„¤íŠ¸ì›Œí¬/ê¶Œí•œ ì´ìŠˆë¡œ ë¡œì»¬ì—ë§Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
  }

  async function removeCurrent(){
    if(!currentId) return;
    if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try{
      await deleteDoc(doc(db,'items',currentId));
      alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      closeModal();
    }catch(e){
      console.error(e);
      items = items.filter(x=>x.id!==currentId); persistLocal(); renderItems(); closeModal();
      alert('ì„œë²„ ì‚­ì œ ì‹¤íŒ¨: ë¡œì»¬ì—ì„œë§Œ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ë³€ê²½ í¬ì¸íŠ¸: ì…ê³ /ì¶œê³ ëŠ” ì„±ê³µ/ì‹¤íŒ¨ì™€ ë¬´ê´€í•˜ê²Œ ì¦‰ì‹œ ë¡œì»¬ì— ë°˜ì˜í•˜ê³  ë Œë”ë§
  async function inbound(){
    if(!currentId) return;
    const idx=items.findIndex(x=>x.id===currentId); if(idx<0) return;
    const q = Number(d.t_qty.value || 0); if(q<=0){ alert('ì…ê³  ìˆ˜ëŸ‰ì€ ì–‘ìˆ˜ë¡œ ì…ë ¥'); return; }
    const date = d.t_date.value || todayStr(); const price = d.t_price.value; const note = d.t_note.value; const user = d.t_user.value;
    const item = items[idx];
    const entry = { date, delta:q, note:(note||'').trim(), price: price!==''&&price!=null?Number(price):null, user:(user||'').trim(), ts: Date.now() };

    // ì¦‰ì‹œ UI ë°˜ì˜
    item.qty = Number(item.qty||0) + q;
    item.stockDate = date;
    if(entry.price!=null) item.price = entry.price;
    item.history = item.history || [];
    item.history.push(entry);
    persistLocal(); renderItems(); if(currentId) renderHistory(item);

    // ì„œë²„ ë°˜ì˜
    try{
      await updateDoc(doc(db,'items',currentId), { qty:item.qty, stockDate:date, price:item.price, history:item.history });
      d.t_qty.value=''; d.t_date.value=''; d.t_price.value=''; d.t_user.value=''; d.t_note.value='';
    }catch(e){
      console.error(e);
      alert('ì„œë²„ ë°˜ì˜ ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬/ê¶Œí•œ ë¬¸ì œ (í™”ë©´ì—ëŠ” ë¡œì»¬ë¡œ ë°˜ì˜ë¨)');
    }
  }

  async function outbound(){
    if(!currentId) return;
    const idx=items.findIndex(x=>x.id===currentId); if(idx<0) return;
    const q = Number(d.t_qty.value || 0); if(q<=0){ alert('ì¶œê³  ìˆ˜ëŸ‰ì€ ì–‘ìˆ˜ë¡œ ì…ë ¥'); return; }
    const user = (d.t_user.value||'').trim(); if(!user){ alert('ì¶œê³  ì‚¬ìš©ì ì…ë ¥'); return; }
    const date = d.t_date.value || todayStr(); const note = d.t_note.value;
    const item = items[idx];
    const entry = { date, delta:-q, note:(note||'').trim(), price:null, user, ts: Date.now() };

    // ì¦‰ì‹œ UI ë°˜ì˜
    item.qty = Number(item.qty||0) - q;
    item.stockDate = date;
    item.history = item.history || [];
    item.history.push(entry);
    persistLocal(); renderItems(); if(currentId) renderHistory(item);

    // ì„œë²„ ë°˜ì˜
    try{
      await updateDoc(doc(db,'items',currentId), { qty:item.qty, stockDate:date, history:item.history });
      d.t_qty.value=''; d.t_date.value=''; d.t_price.value=''; d.t_user.value=''; d.t_note.value='';
    }catch(e){
      console.error(e);
      alert('ì„œë²„ ë°˜ì˜ ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬/ê¶Œí•œ ë¬¸ì œ (í™”ë©´ì—ëŠ” ë¡œì»¬ë¡œ ë°˜ì˜ë¨)');
    }
  }

  function editItem(id){
    const item=items.find(x=>x.id===id); if(!item) return;
    currentId=id;
    f.name.value=item.name||''; f.manufacturer.value=item.manufacturer||''; f.catalog.value=item.catalog||'';
    f.topLab.value=item.topLab||''; populateSubLab(f.subLab, f.topLab.value, item.subLab||''); f.location.value=item.location||'';
    f.qty.value=Number(item.qty||0); f.unit.value=item.unit||''; f.price.value=Number(item.price||0);
    f.stockDate.value=item.stockDate||''; f.createdAt.value=item.createdAt||'';
    f.editBadge.style.display='inline-flex'; window.scrollTo({top:0,behavior:'smooth'});
  }

  document.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click',()=>{ const key=th.getAttribute('data-sort'); sortDir = (sortKey===key && sortDir==='asc')?'desc':'asc'; sortKey=key; renderItems(); });
  });

  f.topLab.addEventListener('change',()=>populateSubLab(f.subLab, f.topLab.value, ""));
  f.subLab.addEventListener('change',()=>{
    if(f.subLab.value===CUSTOM_TOKEN){ $('#subLabCustomWrap').style.display='block'; f.subLabCustom.focus(); }
    else { $('#subLabCustomWrap').style.display='none'; f.subLabCustom.value=''; }
  });
  f.btnReset.addEventListener('click', resetMainForm);
  f.btnApply.addEventListener('click', createOrUpdate);
  f.searchInput.addEventListener('input', renderItems);
  f.btnClearSearch.addEventListener('click', ()=>{ f.searchInput.value=''; renderItems(); f.searchInput.focus(); });
  d.btnClose.addEventListener('click', closeModal);
  d.btnDelete.addEventListener('click', removeCurrent);
  d.btnInbound.addEventListener('click', inbound);
  d.btnOutbound.addEventListener('click', outbound);
  d.btnCopyHistory.addEventListener('click', ()=>{
    if(!currentId){ alert('í’ˆëª©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.'); return; }
    const item=items.find(x=>x.id===currentId); if(!item) return;
    const header=['ë‚ ì§œ','ìˆ˜ëŸ‰(+/-)','ë¹„ê³ ','ê°€ê²©(ì›)','ì‚¬ìš©ì','ê¸°ë¡ì‹œê°'];
    const rows=(item.history||[]).map(h=>[h.date||'', h.delta??'', h.note||'', h.price!=null?h.price:'', h.user||'', h.ts?new Date(h.ts).toISOString():'']);
    const tsv=[header,...rows].map(r=>r.map(v=>String(v).replaceAll('\\t',' ').replaceAll('\\n',' ')).join('\\t')).join('\\n');
    navigator.clipboard.writeText(tsv).then(()=>alert('íˆìŠ¤í† ë¦¬ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.')).catch(()=>alert('ë³µì‚¬ ì‹¤íŒ¨'));
  });
  d.btnExportHistoryCSV.addEventListener('click', ()=>{
    if(!currentId){ alert('í’ˆëª©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.'); return; }
    const item=items.find(x=>x.id===currentId); if(!item){ alert('í’ˆëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
    const header=['itemName','date','delta','note','price','user','ts'];
    const rows=(item.history||[]).map(h=>[item.name,h.date||'',h.delta??'',h.note||'',h.price!=null?h.price:'',h.user||'',h.ts?new Date(h.ts).toISOString():'']);
    const ws=XLSX.utils.aoa_to_sheet([header,...rows]); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'History'); XLSX.writeFile(wb,`history_${item.name}_${todayStr()}.xlsx`);
  });
  btnRetry.addEventListener('click',()=>{ window.location.reload(); });

  function attachRealtime(){
    const qref = query(collection(db,'items'), orderBy('name'));
    unsubscribe = onSnapshot(qref, {includeMetadataChanges:true}, (snap)=>{
      const arr=[];
      snap.forEach(docSnap=>{
        const data=docSnap.data();
        arr.push({
          id:docSnap.id,
          name:data.name||'',
          manufacturer:data.manufacturer||'',
          catalog:data.catalog||'',
          topLab:data.topLab||'',
          subLab:data.subLab||'',
          location:data.location||'',
          qty:Number(data.qty||0),
          unit:data.unit||'',
          price:Number(data.price||0),
          stockDate:data.stockDate||'',
          createdAt:data.createdAt||'',
          history:Array.isArray(data.history)?data.history:[]
        });
      });
      items = arr; localStorage.setItem(storeKey, JSON.stringify(items)); renderItems();
      const fromCache = snap.metadata.fromCache;
      const pending = snap.metadata.hasPendingWrites;
      if(fromCache && !pending){ setSyncPill('Offline','ìºì‹œ'); statusMsg.textContent='ì˜¤í”„ë¼ì¸ ìºì‹œì—ì„œ í‘œì‹œ ì¤‘'; }
      else if(pending){ setSyncPill('Online','ë™ê¸°í™” ì¤‘'); statusMsg.textContent='ì„œë²„ë¡œ ê¸°ë¡ ì „ì†¡ ì¤‘â€¦'; }
      else { setSyncPill('Online','ì •ìƒ'); statusMsg.textContent='ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘'; }
      if(currentId){
        const cur = items.find(x=>x.id===currentId);
        if(cur) renderHistory(cur);
      }
      f.btnApply.disabled = !authed;
    }, (err)=>{
      console.error('onSnapshot error', err);
      setSyncPill('Error','ì—ëŸ¬'); statusMsg.textContent='ì‹¤ì‹œê°„ ìˆ˜ì‹  ì˜¤ë¥˜: ' + (err?.message || err);
      btnRetry.style.display='inline-flex';
    });
  }

  async function start(){
    setAuthPill('í™•ì¸ì¤‘');
    try{
      await signInAnonymously(auth);
      authed=true; setAuthPill('ì„±ê³µ'); f.btnApply.disabled=false;
    }catch(e){
      console.error('Auth ì‹¤íŒ¨', e);
      authed=false; setAuthPill('ì‹¤íŒ¨'); f.btnApply.disabled=false; // ë¡œì»¬ë¡œë¼ë„ ì‚¬ìš©
      showErrorLine('ì¸ì¦ ì‹¤íŒ¨: Firebase Consoleì—ì„œ Anonymous ì¸ì¦ì„ í™œì„±í™”í•´ ì£¼ì„¸ìš”.');
    }
    attachRealtime();
    if(items.length===0){
      const raw=localStorage.getItem(storeKey);
      items = raw ? JSON.parse(raw) : [];
      renderItems();
    }
  }

  // init
  populateSubLab(f.subLab,''); renderItems();
  onAuthStateChanged(auth, (user)=>{ if(user){ authed=true; setAuthPill('ì„±ê³µ'); f.btnApply.disabled=false; } });
  start();

  // export/import
  document.querySelector('#btnExportXLSX').addEventListener('click', ()=>{
    const header=['id','name','manufacturer','catalog','topLab','subLab','location','qty','unit','price','stockDate','createdAt'];
    const rows=items.map(x=>[x.id,x.name,x.manufacturer,x.catalog,x.topLab,x.subLab,x.location,x.qty,x.unit,x.price,x.stockDate,x.createdAt]);
    const ws=XLSX.utils.aoa_to_sheet([header,...rows]); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Items'); XLSX.writeFile(wb,`items_${todayStr()}.xlsx`);
  });
  document.querySelector('#btnImportXLSX').addEventListener('click', ()=>$('#fileInputXLSX').click());
  document.querySelector('#fileInputXLSX').addEventListener('change', async (e)=>{
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload = async (evt)=>{
      try{
        const data=new Uint8Array(evt.target.result);
        const wb=XLSX.read(data,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const rows=XLSX.utils.sheet_to_json(ws);
        for(const r of rows){
          const rec={
            id: r.id || crypto.randomUUID(),
            name:r.name||'', manufacturer:r.manufacturer||'', catalog:r.catalog||'',
            topLab:r.topLab||'', subLab:r.subLab||'', location:r.location||'',
            qty:Number(r.qty||0), unit:r.unit||'', price:Number(r.price||0),
            stockDate:r.stockDate||todayStr(), createdAt:r.createdAt||todayStr(),
            history: []
          };
          try{ await setDoc(doc(db,'items',rec.id), rec, {merge:true}); }
          catch(e){ console.warn('ì„œë²„ ì‹¤íŒ¨ â†’ ë¡œì»¬ ë°˜ì˜', e); const idx=items.findIndex(x=>x.id===rec.id); if(idx>=0) items[idx]={...items[idx],...rec}; else items.push(rec); localStorage.setItem(storeKey, JSON.stringify(items)); }
        }
        alert('ì—‘ì…€ ì—…ë¡œë“œ/ë³‘í•© ì™„ë£Œ'); e.target.value='';
      }catch(err){ console.error(err); alert('ì—‘ì…€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜'); }
    };
    reader.readAsArrayBuffer(file);
  });
</script>

<footer style="padding:20px 16px;text-align:center;color:#6b7280;">This system page is copyrighted by GFC Life Science and JINWOO MIN</footer>
</body>
</html>
