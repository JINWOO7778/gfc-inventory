<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì§€ì—í”„ì”¨ìƒëª…ê³¼í•™ ì¬ê³  ê´€ë¦¬ (ê²€ìƒ‰ ë° ë‚ ì§œ ê°œì„  V7)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand-primary:#006d77; --brand-secondary:#83c5be; --brand-bg:#edf6f9;
      --gap:14px; --border:#e6e9ef; --muted:#5f6b7a; --bg:#f7fafc; --card:#fff;
      --thead:#eaf1ff; --thead-text:#0e1a2b; --row-hover:#f3f6fb; --text:#111825;
      --danger:#ef4444; --danger-600:#dc2626; --ok:#10b981; --ok-600:#059669;
      --shadow:0 1px 2px rgba(16,24,40,.06),0 1px 3px rgba(16,24,40,.1);
    }
    *{box-sizing:border-box;} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);}
    header{padding:10px 16px;border-bottom:1px solid var(--border);background:var(--card);position:sticky;top:0;z-index:30;display:flex;flex-direction:column;gap:10px;box-shadow:var(--shadow);}
    .topline{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .logo-area{display:flex;align-items:center;gap:10px;font-weight:600;color:var(--brand-primary);} .logo{height:32px;object-fit:contain;}
    .csv-actions{display:flex;gap:10px;align-items:center;}
    .csv-actions button{padding:8px 12px;font-size:13px;border-radius:8px;background:var(--brand-primary);color:#fff;border:none;cursor:pointer;}
    #btnMigrate { display: none; background: #f59e0b !important; }
    .statusbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;font-size:12px;padding:8px 10px;border:1px dashed var(--border);border-radius:8px;background:#fafafa;}
    .pill{padding:2px 8px;border-radius:999px;font-weight:600;font-size:11px;border:1px solid #d1d5db;background:#fff;}
    main{padding:20px;display:grid;gap:24px;max-width:1200px;margin:0 auto;}
    .card{border:1px solid var(--border);border-radius:12px;background:var(--card);box-shadow:var(--shadow);} 
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:16px;background:#f9fafb;font-weight:600;}
    .card .body{padding:16px;}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:var(--gap);align-items:start;}
    .field label{display:block;margin-bottom:6px;color:#374151;font-size:13px;font-weight:500;}
    .field input,.field select{width:100%;padding:9px 11px;border:1px solid var(--border);border-radius:8px;background:#fff;font-size:14px;outline:none;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;}
    .btn{cursor:pointer;font-size:14px;border-radius:8px;padding:9px 14px;border:1px solid var(--border);background:#fff;}
    .btn-primary{background:var(--brand-primary);border:none;color:#fff;}
    .btn-ghost:hover{background:#f3f4f6;} .btn-danger{background:var(--danger);border:none;color:#fff;}
    .btn-ok{background:var(--ok);border:none;color:#fff;}
    .table-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:10px;background:#fff;}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:1000px;}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle;font-size:13px;}
    thead th{background:var(--thead);color:var(--thead-text);font-weight:600;}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50;}
    .modal.open{display:flex;} .dialog{width:min(960px,100%);max-height:90vh;background:#fff;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;}
    .modal .head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);background:#f9fafb;}
    .modal .content{padding:16px;overflow-y:auto;}
    .num{text-align:right;}
    .quick-tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;}
    .tag-btn{font-size:11px;padding:4px 8px;border-radius:6px;border:1px solid var(--brand-secondary);background:var(--brand-bg);cursor:pointer;color:var(--brand-primary);}
    .tag-btn:hover{background:var(--brand-secondary);color:#fff;}
  </style>
</head>
<body>

<header>
  <div class="topline">
    <div class="logo-area"><img src="ì§€ì—í”„ì”¨-ë¡œê³  PNG.png" class="logo" alt="GFC"/><span>ì§€ì—í”„ì”¨ìƒëª…ê³¼í•™ ì¬ê³  ê´€ë¦¬</span></div>
    <div class="csv-actions">
      <button id="btnMigrate">âš™ï¸ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</button>
      <button id="btnExportXLSX">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
    </div>
  </div>
  <div class="statusbar">
    <span class="pill pill-auth" id="authPill">Auth: í™•ì¸ì¤‘</span>
    <span class="pill pill-online" id="syncPill">Sync: ì˜¨ë¼ì¸</span>
    <span id="statusMsg" style="color:#6b7280;">ì‹œìŠ¤í…œ ì •ìƒ (Ctrl+Shift+M ê´€ë¦¬ì ëª¨ë“œ)</span>
  </div>
</header>

<main>
  <section class="card">
    <h2>ğŸ” í†µí•© ê²€ìƒ‰ (ì—°êµ¬ì†Œ, Lab, í’ˆëª©ëª… ë“±)</h2>
    <div class="body">
      <input type="text" id="searchInput" placeholder="ì˜ˆ: ì„¸í¬ê³µì •íŒ€ ê³µì •ê°œë°œLab (ê³µë°±ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ë‹¤ì¤‘ ê²€ìƒ‰ ê°€ëŠ¥)" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);"/>
    </div>
  </section>

  <section class="card">
    <h2>â• í’ˆëª© ë“±ë¡/ìˆ˜ì • <span class="pill" id="editBadge" style="display:none;">âœ ìˆ˜ì • ëª¨ë“œ</span></h2>
    <div class="body">
      <div class="form-grid">
        <div class="field"><label>í’ˆëª©ëª… *</label><input id="name" placeholder="ì…ë ¥ ì‹œ ê¸°ì¡´ ì •ë³´ ìë™ í˜¸ì¶œ"/></div>
        <div class="field"><label>Cat#</label><input id="catalog" placeholder="ì…ë ¥ ì‹œ ê¸°ì¡´ ì •ë³´ ìë™ í˜¸ì¶œ"/></div>
        <div class="field"><label>ìƒìœ„ì—°êµ¬ì†Œ</label>
          <select id="topLab">
            <option value="">ì „ì²´ê³µìš©</option>
            <option value="ì„¸í¬ê³µì •íŒ€">ì„¸í¬ê³µì •íŒ€</option>
            <option value="GBC ì—°êµ¬ì†Œ">GBC ì—°êµ¬ì†Œ</option>
            <option value="HMC ì—°êµ¬ì†Œ">HMC ì—°êµ¬ì†Œ</option>
            <option value="RNA ì¹˜ë£Œì œ ì—°êµ¬ì†Œ">RNA ì¹˜ë£Œì œ ì—°êµ¬ì†Œ</option>
            <option value="ì˜ë£Œê¸°ê¸°-ë™íƒ„1ê³µì¥">ì˜ë£Œê¸°ê¸°-ë™íƒ„1ê³µì¥</option>
          </select>
        </div>
        <div class="field"><label>í•˜ìœ„Lab</label><select id="subLab"></select></div>
        <div class="field"><label>ì œì¡°ì‚¬</label><input id="manufacturer"/></div>
        <div class="field"><label>ìœ„ì¹˜</label><input id="location"/></div>
        <div class="field"><label>ì´ˆê¸°ì¬ê³ </label><input type="number" id="qty" value="0"/></div>
        <div class="field"><label>ë‹¨ìœ„</label><input id="unit"/></div>
        <div class="field"><label>ë‹¨ê°€(ì›)</label><input type="number" id="price" value="0"/></div>
      </div>
      <div class="actions" style="margin-top:14px;">
        <button class="btn btn-ghost" id="btnReset">í¼ ì´ˆê¸°í™”</button>
        <button class="btn btn-primary" id="btnApply" disabled>ì €ì¥í•˜ê¸°</button>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>ğŸ“‹ í’ˆëª© ëª©ë¡</h2>
    <div class="body">
      <div class="table-wrap">
        <table id="itemsTable">
          <thead><tr><th>ì‘ì—…</th><th>í’ˆëª©ëª…</th><th>Cat#</th><th>ìƒìœ„ì—°êµ¬ì†Œ</th><th>í•˜ìœ„Lab</th><th class="num">ì¬ê³ </th><th>ë‹¨ìœ„</th><th>ìµœì¢…í™•ì¸</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<div class="modal" id="detailModal">
  <div class="dialog">
    <div class="head">
      <h3 id="detailTitle">ìƒì„¸ ê´€ë¦¬</h3>
      <div class="actions">
        <button class="btn btn-danger" id="btnDelete">ì‚­ì œ</button>
        <button class="btn btn-ghost" id="btnClose">ë‹«ê¸°</button>
      </div>
    </div>
    <div class="content">
      <div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid var(--border);">
        <h4 style="margin:0 0 10px 0;">ì…ì¶œê³  ì…ë ¥</h4>
        <div class="form-grid">
          <div class="field"><label>ë‚ ì§œ ì„ íƒ</label><input type="date" id="t_date"/></div>
          <div class="field"><label>ìˆ˜ëŸ‰(+/-)</label><input type="number" id="t_qty"/></div>
          <div class="field"><label>ë‹´ë‹¹ì</label><input id="t_user"/></div>
          <div class="field" style="grid-column: span 1;">
            <label>ë¹„ê³  (ì‚¬ìœ  í€µ ë²„íŠ¼)</label>
            <input id="t_note"/>
            <div class="quick-tags">
              <button class="tag-btn" onclick="setNote('ì‹¤í—˜ìš©')">ğŸ§ª ì‹¤í—˜ìš©</button>
              <button class="tag-btn" onclick="setNote('ìƒ˜í”Œ')">ğŸ ìƒ˜í”Œ</button>
              <button class="tag-btn" onclick="setNote('íê¸°')">ğŸ—‘ï¸ íê¸°</button>
              <button class="tag-btn" onclick="setNote('ì‹¤ì‚¬')">ğŸ“‹ ì‹¤ì‚¬</button>
            </div>
          </div>
          <div class="actions" style="align-self: flex-end; grid-column: 1/-1; justify-content: flex-end;">
            <button class="btn btn-ok" id="btnInbound">ì…ê³ (+)</button>
            <button class="btn btn-primary" id="btnOutbound" style="margin-left:8px;">ì¶œê³ (-)</button>
          </div>
        </div>
      </div>
      <div class="table-wrap">
        <table id="historyTable">
          <thead><tr><th>ê¸°ë¡ë‚ ì§œ</th><th class="num">ë³€ë™</th><th>ë‹´ë‹¹ì</th><th>ë¹„ê³ </th><th>ë“±ë¡ì‹œê°</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, increment, runTransaction, addDoc, getDocs, writeBatch, deleteField, limit } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:"AIzaSyCTn9uq5vSbAn8SnxIlG_AwXvvz8_Is5R4",
    authDomain:"gfc-inventory.firebaseapp.com",
    projectId:"gfc-inventory",
    storageBucket:"gfc-inventory.firebasestorage.app",
    messagingSenderId:"402572923133",
    appId:"1:402572923133:web:7a8bcbd02d2ce23939ee94"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const nf = new Intl.NumberFormat('ko-KR');
  const todayStr = () => new Date().toISOString().slice(0,10);

  let items = [];
  let currentId = null;
  let historyUnsub = null;

  const $ = s => document.querySelector(s);
  const f = {
    name: $('#name'), manufacturer: $('#manufacturer'), catalog: $('#catalog'),
    topLab: $('#topLab'), subLab: $('#subLab'), qty: $('#qty'),
    unit: $('#unit'), price: $('#price'), btnApply: $('#btnApply'), location: $('#location')
  };

  const subLabMap = {
    "ì„¸í¬ê³µì •íŒ€": ["ê³µì •ê°œë°œLab", "ì„¸í¬ì¹˜ë£Œì œLab"],
    "GBC ì—°êµ¬ì†Œ": ["ë§ˆì´í¬ë¡œë°”ì´ì˜´Lab","ìœµí•©ê¸°ìˆ  Lab","ì¬ìƒë°”ì´ì˜¤ Lab"],
    "HMC ì—°êµ¬ì†Œ": ["í™œì„±ì—°êµ¬ Lab","ì‹ë¬¼ì„¸í¬ì—°êµ¬Lab","ì œí˜•ì—°êµ¬Lab","ì‹ ì†Œì¬ì—°êµ¬ Lab"],
    "RNA ì¹˜ë£Œì œ ì—°êµ¬ì†Œ": ["RNA Lab"],
    "ì˜ë£Œê¸°ê¸°-ë™íƒ„1ê³µì¥": ["ë¬´ê· ì‹¤","ì„±í˜•ì‹¤","ì¡°ë¦½ì‹¤","ë©¸ê· /í¬ì¥","QA/QC","ì°½ê³ "]
  };

  window.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.shiftKey && e.code === 'KeyM') {
      const btn = $('#btnMigrate');
      btn.style.display = (btn.style.display === 'block') ? 'none' : 'block';
      alert("ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”");
    }
  });

  f.topLab.onchange = () => {
    const labs = subLabMap[f.topLab.value] || [];
    f.subLab.innerHTML = '<option value="">ë¯¸ì§€ì •(ì „ì²´)</option>' + labs.map(l => `<option value="${l}">${l}</option>`).join('');
  };

  const autoFill = (e) => {
    if (currentId) return;
    const val = e.target.value.trim();
    if (val.length < 2) return;
    const match = items.find(i => i.catalog === val || i.name === val);
    if (match) {
      f.name.value = match.name || ''; f.catalog.value = match.catalog || '';
      f.manufacturer.value = match.manufacturer || ''; f.unit.value = match.unit || '';
      f.price.value = match.price || 0; f.topLab.value = match.topLab || '';
      f.topLab.onchange(); f.subLab.value = match.subLab || '';
      f.location.value = match.location || '';
    }
  };
  f.catalog.addEventListener('input', autoFill);
  f.name.addEventListener('input', autoFill);

  window.setNote = (txt) => { $('#t_note').value = txt; };

  onSnapshot(query(collection(db, 'items'), orderBy('name')), (snap) => {
    items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderItems();
  });

  // ê²€ìƒ‰ ë¡œì§: ìƒìœ„ì—°êµ¬ì†Œ + í•˜ìœ„Lab + í’ˆëª©ëª… ëª¨ë‘ ê²€ìƒ‰ ê°€ëŠ¥í•˜ë„ë¡ ìˆ˜ì •
  function renderItems() {
    const raw = $('#searchInput').value.toLowerCase();
    const terms = raw.split(/\s+/).filter(Boolean);
    const filtered = items.filter(i => {
      const blob = `${i.name} ${i.catalog} ${i.topLab} ${i.subLab} ${i.manufacturer} ${i.location}`.toLowerCase();
      return terms.every(t => blob.includes(t));
    });
    const tbody = $('#itemsTable tbody');
    tbody.innerHTML = '';
    filtered.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <button class="btn btn-ghost" onclick="window.openDetail('${item.id}')">ìƒì„¸</button>
          <button class="btn btn-ghost" onclick="window.editItem('${item.id}')">í¸ì§‘</button>
        </td>
        <td><b>${item.name}</b></td>
        <td>${item.catalog || ''}</td>
        <td>${item.topLab || ''}</td>
        <td>${item.subLab || ''}</td>
        <td class="num">${nf.format(item.qty || 0)}</td>
        <td>${item.unit || ''}</td>
        <td>${item.stockDate || ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  $('#searchInput').oninput = renderItems;

  f.btnApply.onclick = async () => {
    if(!f.name.value) return alert('í’ˆëª©ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
    const data = {
      name: f.name.value, manufacturer: f.manufacturer.value, catalog: f.catalog.value,
      topLab: f.topLab.value, subLab: f.subLab.value, unit: f.unit.value,
      price: Number(f.price.value), stockDate: todayStr(), location: f.location.value
    };
    if(currentId) {
      await updateDoc(doc(db, 'items', currentId), data);
      alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      const newId = crypto.randomUUID();
      await setDoc(doc(db, 'items', newId), { ...data, id: newId, qty: Number(f.qty.value), createdAt: todayStr() });
      alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    window.resetForm();
  };

  window.openDetail = async (id) => {
    currentId = id;
    const item = items.find(i => i.id === id);
    $('#detailTitle').textContent = `ìƒì„¸: ${item.name}`;
    $('#t_date').value = todayStr(); // ìƒì„¸ ì—´ ë•Œ ë‚ ì§œë¥¼ ì˜¤ëŠ˜ë¡œ ì´ˆê¸°í™”
    $('#detailModal').classList.add('open');
    if(historyUnsub) historyUnsub();
    const hQuery = query(collection(db, 'items', id, 'history'), orderBy('createdAt', 'desc'), limit(50));
    historyUnsub = onSnapshot(hQuery, (snap) => {
      const hTbody = $('#historyTable tbody');
      hTbody.innerHTML = '';
      snap.forEach(d => {
        const h = d.data();
        hTbody.innerHTML += `<tr>
          <td>${h.date}</td>
          <td class="num" style="color:${h.delta>0?'#059669':'#dc2626'}"><b>${h.delta>0?'+':''}${h.delta}</b></td>
          <td>${h.user || ''}</td>
          <td>${h.note || ''}</td>
          <td style="font-size:11px; color:gray;">${new Date(h.createdAt).toLocaleString()}</td>
        </tr>`;
      });
    });
  };

  $('#btnInbound').onclick = async () => {
    const q = Number($('#t_qty').value);
    const date = $('#t_date').value;
    if(q <= 0) return alert('ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
    if(!date) return alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    const itemRef = doc(db, 'items', currentId);
    await updateDoc(itemRef, { qty: increment(q), stockDate: date });
    await addDoc(collection(itemRef, 'history'), {
      date: date, delta: q, user: $('#t_user').value, note: $('#t_note').value, createdAt: Date.now()
    });
    $('#t_qty').value = ''; $('#t_note').value = ''; alert('ì…ê³  ì™„ë£Œ');
  };

  $('#btnOutbound').onclick = async () => {
    const q = Number($('#t_qty').value);
    const date = $('#t_date').value;
    if(q <= 0) return alert('ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
    if(!date) return alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    try {
      await runTransaction(db, async (transaction) => {
        const itemDoc = await transaction.get(doc(db, 'items', currentId));
        if((itemDoc.data().qty || 0) < q) throw "ì¬ê³  ë¶€ì¡±";
        transaction.update(itemDoc.ref, { qty: increment(-q), stockDate: date });
        transaction.set(doc(collection(itemDoc.ref, 'history')), {
          date: date, delta: -q, user: $('#t_user').value, note: $('#t_note').value, createdAt: Date.now()
        });
      });
      $('#t_qty').value = ''; $('#t_note').value = ''; alert('ì¶œê³  ì™„ë£Œ');
    } catch(e) { alert(e); }
  };

  $('#btnMigrate').onclick = async () => {
    const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸");
    if (pw !== '9311aabb') return alert("ì˜¤ë¥˜");
    const snap = await getDocs(collection(db, 'items'));
    let batch = writeBatch(db);
    snap.forEach(d => {
      const data = d.data();
      if(Array.isArray(data.history)) {
        data.history.forEach(h => {
          batch.set(doc(collection(db, 'items', d.id, 'history')), { ...h, createdAt: h.ts || Date.now() });
        });
        batch.update(d.ref, { history: deleteField() });
      }
    });
    await batch.commit();
    alert('ì™„ë£Œ');
    $('#btnMigrate').style.display = 'none';
  };

  window.resetForm = () => {
    currentId = null;
    $('#section-create .body input').forEach(i => i.value = '');
    $('#editBadge').style.display = 'none';
  };
  $('#btnReset').onclick = window.resetForm;
  $('#btnClose').onclick = () => { $('#detailModal').classList.remove('open'); if(historyUnsub) historyUnsub(); };
  
  window.editItem = (id) => {
    const item = items.find(i => i.id === id);
    currentId = id; f.name.value = item.name; f.manufacturer.value = item.manufacturer || '';
    f.catalog.value = item.catalog || ''; f.topLab.value = item.topLab || '';
    f.topLab.onchange(); f.subLab.value = item.subLab || '';
    f.unit.value = item.unit || ''; f.price.value = item.price || 0;
    f.location.value = item.location || '';
    $('#editBadge').style.display = 'inline'; window.scrollTo(0,0);
  };

  signInAnonymously(auth).then(() => { $('#authPill').textContent = 'Auth: OK'; f.btnApply.disabled = false; });

  $('#btnExportXLSX').onclick = () => {
    const ws = XLSX.utils.json_to_sheet(items);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventory");
    XLSX.writeFile(wb, `GFC_Stock_${todayStr()}.xlsx`);
  };
</script>
</body>
</html>