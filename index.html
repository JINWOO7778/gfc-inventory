<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>GFC 연구소 재고관리 (Firestore 실시간 + CSV)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { color-scheme: light dark; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, sans-serif; margin: 24px; }
  h1 { margin: 0 0 12px; font-size: 22px; }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
  input, select, button { padding:8px; font-size:14px; }
  input[type="number"] { width:120px; }
  input[type="date"] { width:175px; }
  input[type="text"] { width:220px; }
  .grow { flex:1; min-width:220px; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:left; }
  th { background:#f4f4f4; user-select:none; }
  tfoot td { font-weight:600; background:#fafafa; }
  .muted { opacity:.7; font-size:12px; }
  .right { text-align:right; }
  .danger { background:#d9534f; color:#fff; border:none; }
  .primary { background:#0d6efd; color:#fff; border:none; }
  .secondary { background:#6c757d; color:#fff; border:none; }
  .ghost { background:transparent; border:1px solid #ccc; }
  .badge { display:inline-block; padding:2px 6px; border-radius:10px; background:#eee; font-size:12px; }
  .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .qtybar button { padding:4px 6px; font-size:12px; margin-right:4px; }
  .warn { color:#b33; font-weight:600; }
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; }
  .modal { background:#fff; color:inherit; width:min(980px, 96vw); max-height:90vh; overflow:auto; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,.2); }
  .modal header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #ddd; }
  .modal header h2 { margin:0; font-size:18px; }
  .modal .content { padding:12px 16px; }
  .modal .actions { display:flex; gap:8px; justify-content:flex-end; padding:12px 16px; border-top:1px solid #ddd; }
  .close { background:#eee; border:none; padding:6px 10px; }
  .csvbar { display:flex; gap:8px; align-items:center; }
</style>
</head>
<body>
<h1>GFC 연구소 소모품 재고관리</h1>

<div class="toolbar">
  <input id="search" class="grow" type="text" placeholder="검색: 품목명, 상위연구소, 하위Lab, 위치" />
  <select id="filterGroup">
    <option value="">상위 연구소(전체)</option>
    <option value="GBC">GBC 연구소</option>
    <option value="HMC">HMC 연구소</option>
    <option value="RNA">RNA 치료제 연구소</option>
  </select>
  <select id="lowStockFilter">
    <option value="">전체</option>
    <option value="low">재고부족만</option>
  </select>
  <input id="lowStockLevel" type="number" step="1" value="5" title="재고부족 기준 수량" />
  <span id="syncState" class="muted">실시간 동기화</span>
</div>

<div class="row csvbar">
  <button id="btnExportCsv" class="ghost">재고 CSV</button>
  <label class="ghost" style="padding:6px 10px; cursor:pointer;">
    재고 CSV 가져오기
    <input id="fileCsv" type="file" accept=".csv,text/csv" style="display:none" />
  </label>
  <span class="muted">CSV 헤더: name,labGroup,lab,loc,reorder,qty,checkDate</span>
</div>

<div class="row">
  <input id="name" type="text" placeholder="품목명" />
  <select id="labGroup">
    <option value="">상위 연구소 선택</option>
    <option value="GBC">GBC 연구소</option>
    <option value="HMC">HMC 연구소</option>
    <option value="RNA">RNA 치료제 연구소</option>
  </select>
  <select id="lab" disabled>
    <option value="">하위 Lab 선택</option>
  </select>
  <input id="loc" type="text" placeholder="위치" />
  <input id="reorder" type="number" step="1" placeholder="재고부족 임계치(선택)" />
  <input id="checkDate" type="date" title="재고 확인 날짜(선택)" />
  <button id="addItemBtn" class="primary">품목 등록</button>
  <button id="resetItemBtn" class="ghost">폼 초기화</button>
</div>

<div class="row">
  <input id="quickName" type="text" placeholder="빠른 조정: 품목명" />
  <input id="quickDelta" type="number" step="1" placeholder="변경 수량(+/-)" />
  <input id="quickDate" type="date" title="재고 확인 날짜(선택)" />
  <button id="quickApplyBtn" class="secondary">적용</button>
</div>

<table id="itemsTable">
  <thead>
    <tr>
      <th>품목명</th>
      <th>상위연구소</th>
      <th>하위Lab</th>
      <th>위치</th>
      <th class="right">현재고</th>
      <th>재고 확인 날짜</th>
      <th>작업</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td>총 품목 <span id="count" class="badge">0</span></td>
      <td colspan="2"></td>
      <td></td>
      <td class="right" id="sumQty">0</td>
      <td></td>
      <td></td>
    </tr>
  </tfoot>
</table>

<div id="detailBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
  <div class="modal">
    <header>
      <h2 id="detailTitle">이력</h2>
      <button id="detailClose" class="close" aria-label="닫기">닫기</button>
    </header>
    <div class="content">
      <div id="detailMeta" class="muted"></div>
      <div class="row">
        <input id="d_date" type="date" />
        <input id="d_qty" type="number" step="1" placeholder="수량 (+입고, -출고)" />
        <input id="d_note" type="text" class="grow" placeholder="비고(예: 발주번호/로트)" />
        <button id="d_add_in" class="secondary">입고</button>
        <button id="d_add_out" class="ghost">출고</button>
      </div>
      <table id="txTable">
        <thead>
          <tr>
            <th>날짜</th>
            <th class="right">수량</th>
            <th>비고</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="actions">
      <button id="detailClose2" class="close">닫기</button>
    </div>
  </div>
</div>

<div class="muted">Tip: 여러 기기에서 같은 URL로 접속하면 Firestore onSnapshot으로 즉시 동기화됩니다.</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, doc, addDoc, updateDoc, deleteDoc,
    onSnapshot, query, orderBy, where, serverTimestamp, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // 1) Firebase 콘솔 값으로 교체
  const firebaseConfig = {
   apiKey: "AIzaSyCTn9uq5vSbAn8SnxIlG_AwXvvz8_Is5R4",
   authDomain: "gfc-inventory.firebaseapp.com",
   projectId: "gfc-inventory",
   storageBucket: "gfc-inventory.firebasestorage.app",
   messagingSenderId: "402572923133",
   appId: "1:402572923133:web:7a8bcbd02d2ce23939ee94"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // 유틸/상태
  const $ = (s)=>document.querySelector(s);
  const LAB_OPTIONS = {
    GBC: ["마이크로바이옴Lab","융합기술 Lab","재생바이오lab"],
    HMC: ["활성연구 Lab","식물세포연구Lab","제형연구 Lab","신소재연구 Lab"],
    RNA: ["RNA Lab"]
  };
  function setupLabSelectorsPair(groupId, labId){
    const g = document.getElementById(groupId);
    const l = document.getElementById(labId);
    function render(){
      const v = g.value || "";
      l.innerHTML = "";
      if (!v || !LAB_OPTIONS[v]) { l.disabled=true; l.innerHTML='<option value="">하위 Lab 선택</option>'; return; }
      l.disabled=false;
      for (const name of LAB_OPTIONS[v]) {
        const o=document.createElement('option'); o.value=name; o.textContent=name; l.appendChild(o);
      }
    }
    g.addEventListener('change', render); render();
  }
  function today(){ return new Date().toISOString().slice(0,10); }
  function num(v){ const n=Number(v); return isNaN(n)?0:n; }
  function toCsvRow(fields){ return fields.map(v => {
    const s = (v ?? '').toString();
    if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }).join(','); }
  function parseCsv(text){
    const rows = [];
    let i=0, field='', inQ=false, row=[];
    while (i<=text.length){
      const ch = text[i] ?? '\n';
      if (inQ){
        if (ch === '"'){
          if (text[i+1] === '"'){ field+='"'; i++; }
          else inQ=false;
        } else field+=ch;
      } else {
        if (ch === '"'){ inQ=true; }
        else if (ch === ','){ row.push(field); field=''; }
        else if (ch === '\n' || i===text.length){ row.push(field); rows.push(row); field=''; row=[]; }
        else field+=ch;
      }
      i++;
    }
    return rows.filter(r => r.length && r.some(c=>c.trim()!==''));
  }

  let itemsCache = [];
  let detailItemId = null;
  let unsubItems = null;
  let unsubTx = null;

  // 실시간 items 구독
  function subscribeItems(){
    const qItems = query(collection(db, "items"), orderBy("name"));
    if (unsubItems) unsubItems();
    unsubItems = onSnapshot(qItems, (snap)=>{
      itemsCache = snap.docs.map(d=>({ id: d.id, ...d.data() }));
      renderItems();
      $('#syncState').textContent='실시간 동기화';
    }, (err)=>{ console.error(err); $('#syncState').textContent='동기화 오류'; });
  }

  // CRUD
  async function addItem(){
    const it = {
      name: $('#name').value.trim(),
      labGroup: $('#labGroup').value,
      lab: $('#lab').value,
      loc: $('#loc').value.trim(),
      reorder: $('#reorder').value.trim()===''? '' : Number($('#reorder').value),
      qty: 0,
      checkDate: $('#checkDate').value || '',
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
    };
    if (!it.name) return alert('품목명 필수');
    if (!it.labGroup || !it.lab) return alert('상위 연구소/하위 Lab 선택');
    await addDoc(collection(db, "items"), it);
    $('#name').value=''; $('#labGroup').value='';
    $('#lab').innerHTML='<option value="">하위 Lab 선택</option>'; $('#lab').disabled=true;
    $('#loc').value=''; $('#reorder').value=''; $('#checkDate').value='';
  }

  async function adjustQty(itemIdRaw, delta, dateOpt, noteOpt){
    const itemId = String(itemIdRaw);
    const it = itemsCache.find(x=>String(x.id)===itemId); if (!it) return;
    const dateVal = dateOpt || it.checkDate || today();
    const newQty = num(it.qty) + num(delta);
    await updateDoc(doc(db,"items", itemId), {
      qty: newQty, checkDate: dateVal, updatedAt: serverTimestamp(),
    });
    await addDoc(collection(db,"tx"), {
      itemId, date: dateVal, qty: num(delta), note: noteOpt || '', createdAt: serverTimestamp(),
    });
  }

  async function setQtyAndDate(itemIdRaw, value, dateOpt, noteOpt){
    const itemId = String(itemIdRaw);
    const it = itemsCache.find(x=>String(x.id)===itemId); if (!it) return;
    const dateVal = dateOpt || it.checkDate || today();
    const delta = num(value) - num(it.qty);
    await updateDoc(doc(db,"items", itemId), {
      qty: num(value), checkDate: dateVal, updatedAt: serverTimestamp(),
    });
    if (delta !== 0){
      await addDoc(collection(db,"tx"), {
        itemId, date: dateVal, qty: delta, note: noteOpt || '수량 직접설정', createdAt: serverTimestamp(),
      });
    }
  }

  async function deleteItem(itemId){
    if (!confirm('품목을 삭제할까요? (이력은 유지됨)')) return;
    await deleteDoc(doc(db,"items", String(itemId)));
    if (detailItemId===String(itemId)) closeDetail();
  }

  // CSV 내보내기
  function exportCsv(){
    const header = ['name','labGroup','lab','loc','reorder','qty','checkDate'];
    const rows = [toCsvRow(header)];
    const arr = itemsCache.slice().sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')));
    for (const it of arr){
      rows.push(toCsvRow([
        it.name||'', it.labGroup||'', it.lab||'', it.loc||'',
        it.reorder===''||it.reorder==null?'':it.reorder,
        it.qty==null?'':it.qty,
        it.checkDate||''
      ]));
    }
    const blob = new Blob([rows.join('\n')], { type:'text/csv;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `inventory_${today()}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // CSV 불러오기(머지 업서트)
  async function importCsv(file){
    const text = await file.text();
    const rows = parseCsv(text);
    if (!rows.length) return alert('CSV 내용이 비어 있습니다');
    const header = rows[0].map(h=>h.trim());
    const idx = Object.fromEntries(header.map((h,i)=>[h,i]));
    const required = ['name','labGroup','lab','loc','reorder','qty','checkDate'];
    for (const k of required){ if (!(k in idx)) return alert('CSV 헤더 확인: ' + required.join(',')); }

    // 현재 items를 이름 기준으로 맵
    const byName = new Map(itemsCache.map(it => [String((it.name||'').toLowerCase()), it]));
    const batch = writeBatch(db);
    const itemsCol = collection(db, 'items');

    for (let r=1; r<rows.length; r++){
      const row = rows[r];
      const name = (row[idx.name]||'').trim();
      if (!name) continue;
      const payload = {
        name,
        labGroup: (row[idx.labGroup]||'').trim(),
        lab: (row[idx.lab]||'').trim(),
        loc: (row[idx.loc]||'').trim(),
        reorder: row[idx.reorder]? Number(row[idx.reorder]) : '',
        qty: row[idx.qty]? Number(row[idx.qty]) : 0,
        checkDate: (row[idx.checkDate]||'').trim(),
        updatedAt: serverTimestamp()
      };
      const key = name.toLowerCase();
      const found = byName.get(key);
      if (found){
        batch.update(doc(db,'items', found.id), payload);
      } else {
        payload.createdAt = serverTimestamp();
        // 새 문서 추가는 batch.add가 없어 개별 addDoc로 처리
        await addDoc(itemsCol, payload);
      }
    }
    await batch.commit();
    alert('CSV 반영 완료');
  }

  // 렌더링/필터
  function filteredItems(){
    const q = $('#search').value.trim().toLowerCase();
    const lowOnly = $('#lowStockFilter').value==='low';
    const lowLevel = num($('#lowStockLevel').value)||0;
    const groupFilter = $('#filterGroup').value;
    let arr = itemsCache.slice();
    if (q){
      arr = arr.filter(x =>
        (x.name||'').toLowerCase().includes(q) ||
        (x.labGroup||'').toLowerCase().includes(q) ||
        (x.lab||'').toLowerCase().includes(q) ||
        (x.loc||'').toLowerCase().includes(q)
      );
    }
    if (groupFilter) arr = arr.filter(x => (x.labGroup||'')===groupFilter);
    if (lowOnly) arr = arr.filter(x => num(x.qty) <= (num(x.reorder)||lowLevel));
    arr.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')));
    return arr;
  }

  function renderItems(){
    const body = document.querySelector('#itemsTable tbody'); body.innerHTML='';
    const arr = filteredItems();
    let sumQty=0;
    for (const it of arr){
      sumQty += num(it.qty);
      const tr = document.createElement('tr');
      tr.setAttribute('data-id', it.id);
      const warn = (num(it.qty) <= (num(it.reorder)||num($('#lowStockLevel').value)||0)) ? '<span class="warn">⚠</span>':'';
      tr.innerHTML = `
        <td class="clickable">${it.name||''} ${warn}</td>
        <td>${it.labGroup||''}</td>
        <td>${it.lab||''}</td>
        <td>${it.loc||''}</td>
        <td class="right">
          <input data-act="setQty" data-id="${it.id}" type="number" step="1" value="${it.qty||0}" style="width:100px;text-align:right;" />
        </td>
        <td>
          <div style="display:flex; gap:6px; align-items:center;">
            <input data-act="setDate" data-id="${it.id}" type="date" value="${it.checkDate||''}" />
          </div>
        </td>
        <td>
          <div class="qtybar">
            <button data-act="adj" data-id="${it.id}" data-delta="10">+10</button>
            <button data-act="adj" data-id="${it.id}" data-delta="1">+1</button>
            <button data-act="adj" data-id="${it.id}" data-delta="-1">-1</button>
            <button data-act="adj" data-id="${it.id}" data-delta="-10">-10</button>
            <button data-act="del" data-id="${it.id}" class="danger">삭제</button>
          </div>
        </td>
      `;
      body.appendChild(tr);
    }
    $('#count').textContent=String(arr.length);
    $('#sumQty').textContent=String(sumQty);
  }

  // 모달/이력
  function openDetail(idRaw){
    detailItemId = String(idRaw);
    renderTxModal(detailItemId);
    $('#detailBackdrop').style.display='flex';
    $('#detailClose').focus();
  }
  function closeDetail(){
    detailItemId = null;
    if (unsubTx) { unsubTx(); unsubTx=null; }
    $('#detailBackdrop').style.display='none';
  }
  function renderTxModal(id){
    const it = itemsCache.find(x=>String(x.id)===String(id)); if (!it) return;
    $('#detailTitle').textContent = `이력 — ${it.name}`;
    $('#detailMeta').textContent = `${it.labGroup||''} / ${it.lab||''} / ${it.loc||''} · 현재고: ${it.qty} · 확인일: ${it.checkDate||'-'}`;
    $('#d_date').value = it.checkDate || today();
    $('#d_qty').value = ''; $('#d_note').value = '';

    if (unsubTx) { unsubTx(); unsubTx=null; }
    const qTx = query(collection(db,"tx"), where("itemId","==",String(id)), orderBy("date","desc"));
    unsubTx = onSnapshot(qTx, (snap)=>{
      const body = document.querySelector('#txTable tbody'); body.innerHTML='';
      const rows = snap.docs.map(d=>d.data());
      for (const t of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.date||''}</td>
          <td class="right">${t.qty>0?`+${t.qty}`:t.qty}</td>
          <td>${t.note||''}</td>
        `;
        body.appendChild(tr);
      }
      if (!rows.length){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="3" class="muted">이력이 없습니다</td>`;
        body.appendChild(tr);
      }
    });
  }

  // 이벤트
  document.getElementById('itemsTable').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if (btn){
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      if (act==='adj'){
        const row = btn.closest('tr');
        const dateVal = row.querySelector('input[data-act="setDate"]')?.value || today();
        await adjustQty(id, Number(btn.dataset.delta||0), dateVal, '');
      } else if (act==='del'){
        await deleteItem(id);
      }
      return;
    }
    if (e.target.closest('input[data-act="setQty"]') || e.target.closest('input[data-act="setDate"]')) return;
    const row = e.target.closest('tr'); if (!row) return;
    const id = row.getAttribute('data-id'); if (id) openDetail(id);
  });

  document.getElementById('itemsTable').addEventListener('change', async (e)=>{
    const qtyInput = e.target.closest('input[data-act="setQty"]');
    if (qtyInput){
      const id = qtyInput.dataset.id;
      const row = qtyInput.closest('tr');
      const dateVal = row.querySelector('input[data-act="setDate"]')?.value || today();
      await setQtyAndDate(id, Number(qtyInput.value||0), dateVal, '수량 직접설정');
      return;
    }
    const dateInput = e.target.closest('input[data-act="setDate"]');
    if (dateInput){
      const id = dateInput.dataset.id;
      await updateDoc(doc(db, "items", String(id)), { checkDate: dateInput.value || '', updatedAt: serverTimestamp() });
      if (detailItemId===String(id)) renderTxModal(id);
      return;
    }
  });

  document.getElementById('detailClose').addEventListener('click', closeDetail);
  document.getElementById('detailClose2').addEventListener('click', closeDetail);
  document.getElementById('detailBackdrop').addEventListener('click', (e)=>{
    if (e.target.id === 'detailBackdrop') closeDetail();
  });
  document.getElementById('d_add_in').addEventListener('click', async ()=>{
    const id = detailItemId; if (!id) return;
    const dateVal = $('#d_date').value || today();
    const qty = num($('#d_qty').value); if (!qty) return alert('수량을 입력하세요');
    await adjustQty(id, Math.abs(qty), dateVal, $('#d_note').value.trim() || '입고');
    $('#d_qty').value=''; $('#d_note').value='';
  });
  document.getElementById('d_add_out').addEventListener('click', async ()=>{
    const id = detailItemId; if (!id) return;
    const dateVal = $('#d_date').value || today();
    const qty = num($('#d_qty').value); if (!qty) return alert('수량을 입력하세요');
    await adjustQty(id, -Math.abs(qty), dateVal, $('#d_note').value.trim() || '출고');
    $('#d_qty').value=''; $('#d_note').value='';
  });

  document.getElementById('addItemBtn').addEventListener('click', addItem);
  document.getElementById('resetItemBtn').addEventListener('click', ()=>{
    $('#name').value=''; $('#labGroup').value='';
    $('#lab').innerHTML='<option value="">하위 Lab 선택</option>'; $('#lab').disabled=true;
    $('#loc').value=''; $('#reorder').value=''; $('#checkDate').value='';
  });
  document.getElementById('quickApplyBtn').addEventListener('click', async ()=>{
    const name = $('#quickName').value.trim().toLowerCase();
    const delta = num($('#quickDelta').value);
    const dateVal = $('#quickDate').value || today();
    if (!name || !delta) return;
    const found = itemsCache.find(x => (x.name||'').toLowerCase()===name);
    if (!found) return alert('해당 품목을 찾을 수 없습니다');
    await adjustQty(found.id, delta, dateVal, '빠른 조정');
    $('#quickDelta').value='';
  });
  document.getElementById('btnExportCsv').addEventListener('click', exportCsv);
  document.getElementById('fileCsv').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if (!f) return;
    await importCsv(f);
    e.target.value='';
  });

  setupLabSelectorsPair('labGroup','lab');
  subscribeItems();
</script>
</body>
</html>