<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GFC생명과학 연구소 소모품 재고관리</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif; margin: 0; padding: 0; }
    header, footer { padding: 12px 16px; background: #0f172a; color: #fff; }
    main { padding: 16px; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; }
    select, input, button { font-size: 14px; padding: 6px 8px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #e5e7eb; padding: 8px; text-align: left; }
    th { background: #f8fafc; position: sticky; top: 0; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; background: #e2e8f0; font-size: 12px; }
    .danger { color: #b91c1c; }
    .muted { color: #64748b; }
    .right { text-align: right; }
    .row-click { cursor: pointer; }
    .toast { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); background: #111827; color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 14px; opacity: 0; transition: opacity .2s; pointer-events: none; }
    .toast.show { opacity: 0.95; }
    .hidden { display: none; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: none; align-items: center; justify-content: center; }
    .modal { background: #fff; border-radius: 8px; max-width: 860px; width: calc(100% - 24px); padding: 16px; }
    .modal h3 { margin-top: 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .full { grid-column: 1 / -1; }
    .actions { display: flex; gap: 8px; justify-content: flex-end; }
    .pill { display: inline-block; border: 1px solid #e5e7eb; background: #f8fafc; padding: 4px 8px; border-radius: 999px; font-size: 12px; margin-right: 6px; }
    .tx-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    .tx-table th, .tx-table td { border-bottom: 1px solid #e5e7eb; padding: 6px 8px; }
    .nowrap { white-space: nowrap; }
  </style>
</head>
<body>
  <header>
    <h1>GFC생명과학 연구소 소모품 재고관리</h1>
  </header>

  <main>
    <!-- 필터/도구바 -->
    <div class="toolbar">
      <label>상위 연구소
        <select id="topGroup">
          <option value="">전체</option>
          <option value="GBC 연구소">GBC 연구소</option>
          <option value="HMC 연구소">HMC 연구소</option>
          <option value="RNA 치료제 연구소">RNA 치료제 연구소</option>
        </select>
      </label>

      <label>하위 Lab
        <select id="subLab">
          <option value="">전체</option>
        </select>
      </label>

      <label>
        <input type="checkbox" id="onlyLow" />
        재고부족만
      </label>

      <input type="search" id="search" placeholder="품목명/위치 검색" />

      <span id="liveBadge" class="badge muted">실시간 동기화 준비</span>

      <button id="exportCsvBtn">재고 CSV</button>
      <input type="file" id="importCsvInput" accept=".csv" class="hidden" />
      <button id="importCsvBtn">재고 CSV 가져오기</button>
      <button id="copyTextBtn">텍스트 복사</button>
    </div>

    <!-- 등록/수정 폼 -->
    <form id="itemForm" class="grid" autocomplete="off">
      <div class="full">
        <strong>품목 등록</strong>
        <button type="button" id="formResetBtn" class="badge">폼 초기화</button>
      </div>

      <label>품목명
        <input name="name" required />
      </label>

      <label>상위연구소
        <select name="group" id="itemRootLab" required>
          <option value="GBC 연구소">GBC 연구소</option>
          <option value="HMC 연구소">HMC 연구소</option>
          <option value="RNA 치료제 연구소">RNA 치료제 연구소</option>
        </select>
      </label>

      <label>하위Lab
        <select name="lab" id="itemChildLab">
          <option value="">선택</option>
        </select>
      </label>

      <label>위치
        <input name="location" />
      </label>

      <label>현재고
        <input name="qty" type="number" step="1" value="0" />
      </label>

      <label>단가(원)
        <input name="unit_cost" type="number" step="1" value="0" />
      </label>

      <label>재고 확인 날짜
        <input name="checked_at" type="date" />
      </label>

      <div class="actions full">
        <button type="submit">적용</button>
      </div>
    </form>

    <!-- 테이블 -->
    <p class="muted">Tip: 행을 클릭하면 해당 품목의 입출고 이력과 상세정보 모달이 열린다.</p>

    <table>
      <thead>
        <tr>
          <th>상세</th>
          <th>품목명</th>
          <th>상위연구소</th>
          <th>하위Lab</th>
          <th>위치</th>
          <th class="right">현재고</th>
          <th class="right">단가(원)</th>
          <th>재고 확인 날짜</th>
          <th>작업</th>
        </tr>
      </thead>
      <tbody id="itemsTbody"></tbody>
    </table>

    <div style="margin-top:8px; display:flex; gap:16px;">
      <div>총 품목 <strong id="totalCount">0</strong></div>
      <div>재고합계 <strong id="totalQty">0</strong></div>
    </div>
  </main>

  <!-- 상세/로그 모달 -->
  <div id="detailModal" class="modal-backdrop">
    <div class="modal">
      <h3 id="detailTitle">상세</h3>
      <div class="full" style="margin:8px 0;">
        <span id="detailMeta" class="pill">-</span>
        <span id="detailLoc" class="pill">-</span>
        <span id="detailQty" class="pill">-</span>
        <span id="detailPrice" class="pill">-</span>
        <span id="detailChecked" class="pill">-</span>
      </div>

      <div class="grid" style="align-items:end; margin-top:4px;">
        <div>
          <label class="nowrap">날짜
            <input id="txDate" type="date" />
          </label>
        </div>
        <div>
          <label class="nowrap">수량(+/-)
            <input id="txQty" type="number" step="1" />
          </label>
        </div>
        <div class="full">
          <label class="nowrap">비고
            <input id="txMemo" />
          </label>
        </div>
        <div class="actions full">
          <button type="button" id="txIn" class="badge">입고</button>
          <button type="button" id="txOut" class="badge">출고</button>
          <button type="button" id="copyTxBtn" class="badge">히스토리 복사</button>
          <button type="button" id="closeDetail" class="badge">닫기</button>
        </div>
      </div>

      <table class="tx-table">
        <thead>
          <tr>
            <th class="nowrap">날짜</th>
            <th class="right nowrap">수량(+/-)</th>
            <th class="nowrap">비고</th>
            <th class="nowrap">기록시각</th>
          </tr>
        </thead>
        <tbody id="txBody"></tbody>
      </table>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Firebase + 앱 스크립트 -->
  <script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc,
      serverTimestamp, runTransaction, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 0) 프로젝트의 Firebase 설정으로 교체
    const firebaseConfig = {
      apiKey: "AIzaSyCTn9uq5vSbAn8SnxIlG_AwXvvz8_Is5R4",
      authDomain: "gfc-inventory.firebaseapp.com",
      projectId: "gfc-inventory",
      storageBucket: "gfc-inventory.firebasestorage.app",
      messagingSenderId: "402572923133",
      appId: "1:402572923133:web:7a8bcbd02d2ce23939ee94"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 1) Lab 의존 옵션 맵
    const labsMap = {
      "GBC 연구소": ["마이크로바이옴Lab", "융합기술 Lab", "재생바이오lab"],
      "HMC 연구소": ["활성연구 Lab", "식물세포연구Lab", "제형연구 Lab", "신소재연구 Lab"],
      "RNA 치료제 연구소": ["RNA Lab"]
    };

    // 2) DOM 헬퍼
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    const topGroup = $("#topGroup");
    const subLab = $("#subLab");
    const onlyLow = $("#onlyLow");
    const search = $("#search");
    const liveBadge = $("#liveBadge");
    const itemsTbody = $("#itemsTbody");
    const totalCount = $("#totalCount");
    const totalQty = $("#totalQty");

    const itemForm = $("#itemForm");
    const formResetBtn = $("#formResetBtn");
    const itemRootLab = $("#itemRootLab");
    const itemChildLab = $("#itemChildLab");

    // 상세 모달
    const detailModal = $("#detailModal");
    const detailTitle = $("#detailTitle");
    const detailMeta = $("#detailMeta");
    const detailLoc = $("#detailLoc");
    const detailQty = $("#detailQty");
    const detailPrice = $("#detailPrice");
    const detailChecked = $("#detailChecked");
    const txBody = $("#txBody");
    const txDate = $("#txDate");
    const txQty = $("#txQty");
    const txMemo = $("#txMemo");
    const txIn = $("#txIn");
    const txOut = $("#txOut");
    const copyTxBtn = $("#copyTxBtn");
    const closeDetail = $("#closeDetail");

    const toast = $("#toast");

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 1600);
    }

    // 3) Lab 옵션 동기화
    function syncChildOptions(rootValue, childSelect, includeAll = false) {
      const options = labsMap[rootValue] || [];
      childSelect.innerHTML = "";
      if (includeAll) {
        const o = document.createElement("option");
        o.value = "";
        o.textContent = "전체";
        childSelect.appendChild(o);
      }
      for (const name of options) {
        const o = document.createElement("option");
        o.value = name;
        o.textContent = name;
        childSelect.appendChild(o);
      }
    }

    // 초기 필터 하위Lab 전체 옵션은 상위 선택 시에 주입
    topGroup.addEventListener("change", () => {
      syncChildOptions(topGroup.value, subLab, true);
      applyFilters(); renderTable();
    });
    // 폼의 하위 Lab 옵션도 상위 선택 시에 주입
    itemRootLab.addEventListener("change", () => {
      syncChildOptions(itemRootLab.value, itemChildLab, false);
    });
    // 초기 폼 옵션 프리셋
    syncChildOptions(itemRootLab.value, itemChildLab, false);

    // 4) Firestore 레퍼런스
    const itemsCol = collection(db, "inventory_items");
    const itemHistoryCol = (itemId) => collection(doc(itemsCol, itemId), "history");

    // 5) 상태
    const state = {
      raw: [],
      view: [],
      detailItemId: null,
      unsubHistory: null, // 현재 상세 아이템의 히스토리 리스너
      historiesCache: new Map() // itemId -> array
    };

    // 6) 필터 적용
    function applyFilters() {
      const q = search.value.trim().toLowerCase();
      const g = topGroup.value;
      const l = subLab.value;
      const lowOnly = onlyLow.checked;

      let arr = state.raw.slice();

      if (g) arr = arr.filter(v => (v.group || "") === g);
      if (l) arr = arr.filter(v => (v.lab || "") === l);
      if (q) {
        arr = arr.filter(v =>
          (v.name || "").toLowerCase().includes(q) ||
          (v.location || "").toLowerCase().includes(q)
        );
      }
      if (lowOnly) {
        arr = arr.filter(v => Number(v.qty || 0) <= 0);
      }
      arr.sort((a,b) => (a.name || "").localeCompare(b.name || "", "ko"));
      state.view = arr;
    }

    // 7) 테이블 렌더
    function renderTable() {
      itemsTbody.innerHTML = "";
      let count = 0;
      let qtySum = 0;

      state.view.forEach(item => {
        count += 1;
        qtySum += Number(item.qty || 0);

        const tr = document.createElement("tr");
        tr.className = "row-click";

        const detailTd = document.createElement("td");
        const detailBtn = document.createElement("button");
        detailBtn.textContent = "상세";
        detailBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          openDetail(item.id);
        });
        detailTd.appendChild(detailBtn);

        const nameTd = document.createElement("td");
        nameTd.textContent = item.name || "";

        const groupTd = document.createElement("td");
        groupTd.textContent = item.group || "";

        const labTd = document.createElement("td");
        labTd.textContent = item.lab || "";

        const locTd = document.createElement("td");
        locTd.textContent = item.location || "";

        const qtyTd = document.createElement("td");
        qtyTd.className = "right";
        qtyTd.textContent = Number(item.qty || 0).toLocaleString();

        const costTd = document.createElement("td");
        costTd.className = "right";
        costTd.textContent = Number(item.unit_cost || 0).toLocaleString();

        const dateTd = document.createElement("td");
        dateTd.textContent = item.checked_at || "";

        const actionTd = document.createElement("td");
        const editBtn = document.createElement("button");
        editBtn.textContent = "수정";
        editBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          itemForm.dataset.editingId = item.id;
          itemForm.name.value = item.name || "";
          itemForm.group.value = item.group || "";
          syncChildOptions(itemForm.group.value, itemChildLab, false);
          itemForm.lab.value = item.lab || "";
          itemForm.location.value = item.location || "";
          itemForm.qty.value = Number(item.qty || 0);
          itemForm.unit_cost.value = Number(item.unit_cost || 0);
          itemForm.checked_at.value = item.checked_at || "";
          window.scrollTo({ top: 0, behavior: "smooth" });
        });

        const delBtn = document.createElement("button");
        delBtn.textContent = "삭제";
        delBtn.addEventListener("click", async (e) => {
          e.stopPropagation();
          if (!confirm("정말 삭제하시겠습니까?")) return;
          await deleteDoc(doc(itemsCol, item.id));
          showToast("삭제됨");
        });

        actionTd.append(editBtn, document.createTextNode(" "), delBtn);

        tr.append(detailTd, nameTd, groupTd, labTd, locTd, qtyTd, costTd, dateTd, actionTd);

        tr.addEventListener("click", () => openDetail(item.id));

        itemsTbody.appendChild(tr);
      });

      totalCount.textContent = count.toLocaleString();
      totalQty.textContent = qtySum.toLocaleString();
    }

    // 8) 실시간 아이템 구독
    let unsubscribeItems = null;
    function startLiveSubscription() {
      if (unsubscribeItems) return;
      const qy = query(itemsCol, orderBy("name","asc"));
      unsubscribeItems = onSnapshot(qy, (snap) => {
        const list = [];
        snap.forEach(d => list.push({ id: d.id, ...d.data() }));
        state.raw = list;
        applyFilters();
        renderTable();
        liveBadge.textContent = "실시간 동기화 중";
        liveBadge.classList.remove("muted");

        // 상세 모달이 열려있다면 헤더 정보 갱신
        if (state.detailItemId) {
          refreshDetailHeader(state.detailItemId);
        }
      }, (err) => {
        console.error(err);
        liveBadge.textContent = "동기화 오류";
        liveBadge.classList.add("muted");
        showToast("실시간 동기화 오류");
      });
    }

    // 9) 쓰기 동작
    async function upsertItem(item) {
      const payload = {
        name: item.name?.trim() || "",
        group: item.group || "",
        lab: item.lab || "",
        location: item.location?.trim() || "",
        qty: Number(item.qty) || 0,
        unit_cost: Number(item.unit_cost) || 0,
        checked_at: item.checked_at || null,
        updated_at: serverTimestamp(),
      };
      if (item.id) {
        await updateDoc(doc(itemsCol, item.id), payload);
      } else {
        payload.created_at = serverTimestamp();
        const newRef = await addDoc(itemsCol, payload);
        // 신규 아이템은 상세 모달로 바로 열 수 있음(옵션)
        // openDetail(newRef.id);
      }
    }

    async function postTransaction(itemId, deltaQty, memo, dateStr) {
      await runTransaction(db, async (tx) => {
        const ref = doc(itemsCol, itemId);
        const snap = await tx.get(ref);
        if (!snap.exists()) throw new Error("Item not found");
        const curr = snap.data();
        const nextQty = (Number(curr.qty) || 0) + (Number(deltaQty) || 0);

        // 수량/날짜 업데이트
        tx.update(ref, {
          qty: nextQty,
          checked_at: dateStr || curr.checked_at || null,
          updated_at: serverTimestamp()
        });

        // 히스토리 기록
        const histRef = doc(itemHistoryCol(itemId));
        tx.set(histRef, {
          date: dateStr || new Date().toISOString().slice(0,10),
          delta: Number(deltaQty) || 0,
          memo: memo || "",
          created_at: serverTimestamp()
        });
      });
    }

    // 10) 상세 모달 + 히스토리 실시간 구독
    function openDetail(itemId) {
      state.detailItemId = itemId;
      detailModal.style.display = "flex";
      txDate.value = new Date().toISOString().slice(0,10);
      txQty.value = "";
      txMemo.value = "";
      refreshDetailHeader(itemId);
      startHistorySubscription(itemId);
    }

    function closeDetailModal() {
      detailModal.style.display = "none";
      stopHistorySubscription();
      state.detailItemId = null;
    }
    closeDetail.addEventListener("click", closeDetailModal);
    detailModal.addEventListener("click", (e) => { if (e.target === detailModal) closeDetailModal(); });

    function refreshDetailHeader(itemId) {
      const it = state.raw.find(x => x.id === itemId);
      if (!it) return;
      detailTitle.textContent = it.name || "-";
      detailMeta.textContent = `${it.group || ""} / ${it.lab || ""}`.trim();
      detailLoc.textContent = `위치: ${it.location || "-"}`;
      detailQty.textContent = `현재고: ${Number(it.qty || 0).toLocaleString()}`;
      detailPrice.textContent = `단가: ${Number(it.unit_cost || 0).toLocaleString()}`;
      detailChecked.textContent = `확인일: ${it.checked_at || "-"}`;
    }

    function renderHistoryRows(itemId) {
      const rows = state.historiesCache.get(itemId) || [];
      txBody.innerHTML = "";
      for (const r of rows) {
        const tr = document.createElement("tr");
        const created = r.created_at?.toDate ? r.created_at.toDate() : (r.created_at || null);
        const createdStr = created ? new Date(created).toLocaleString("ko-KR") : "-";
        tr.innerHTML = `
          <td class="nowrap">${r.date || "-"}</td>
          <td class="right nowrap">${Number(r.delta || 0).toLocaleString()}</td>
          <td>${r.memo || ""}</td>
          <td class="nowrap">${createdStr}</td>
        `;
        txBody.appendChild(tr);
      }
    }

    function startHistorySubscription(itemId) {
      stopHistorySubscription();
      const qh = query(itemHistoryCol(itemId), orderBy("date", "desc"));
      state.unsubHistory = onSnapshot(qh, (snap) => {
        const list = [];
        snap.forEach(d => list.push({ id: d.id, ...d.data() }));
        state.historiesCache.set(itemId, list);
        renderHistoryRows(itemId);
      }, (err) => {
        console.error("history onSnapshot error", err);
        showToast("히스토리 로드 오류");
      });
    }

    function stopHistorySubscription() {
      if (state.unsubHistory) {
        state.unsubHistory();
        state.unsubHistory = null;
      }
    }

    // 입/출고 버튼
    txIn.addEventListener("click", async () => {
      const id = state.detailItemId;
      if (!id) return;
      const delta = Number(txQty.value);
      if (!delta || isNaN(delta)) return showToast("수량을 입력하세요");
      await postTransaction(id, Math.abs(delta), txMemo.value, txDate.value || null);
      showToast("입고 기록됨");
      txQty.value = "";
      txMemo.value = "";
    });

    txOut.addEventListener("click", async () => {
      const id = state.detailItemId;
      if (!id) return;
      const delta = Number(txQty.value);
      if (!delta || isNaN(delta)) return showToast("수량을 입력하세요");
      await postTransaction(id, -Math.abs(delta), txMemo.value, txDate.value || null);
      showToast("출고 기록됨");
      txQty.value = "";
      txMemo.value = "";
    });

    copyTxBtn.addEventListener("click", async () => {
      const id = state.detailItemId;
      if (!id) return;
      const it = state.raw.find(x => x.id === id);
      const rows = (state.historiesCache.get(id) || []).slice().sort((a,b) => (b.date||"").localeCompare(a.date||""));
      const header = `${it?.name || "-"} | ${it?.group || ""} / ${it?.lab || ""} | ${it?.location || "-"}`;
      const lines = [header, "- 히스토리 -"];
      for (const r of rows) {
        lines.push(`${r.date || "-"} | ${Number(r.delta || 0)} | ${r.memo || ""}`);
      }
      const text = lines.join("\n");
      try {
        await navigator.clipboard.writeText(text);
        showToast("히스토리 복사됨");
      } catch {
        const ta = document.createElement("textarea");
        ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove();
        showToast("히스토리 복사됨");
      }
    });

    // 11) 폼/필터 이벤트
    formResetBtn.addEventListener("click", () => {
      itemForm.reset();
      delete itemForm.dataset.editingId;
      // 폼 하위Lab 옵션 재주입
      syncChildOptions(itemRootLab.value, itemChildLab, false);
      showToast("폼 초기화");
    });

    itemForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      await upsertItem({
        id: itemForm.dataset.editingId || null,
        name: itemForm.name.value,
        group: itemForm.group.value,
        lab: itemForm.lab.value,
        location: itemForm.location.value,
        qty: itemForm.qty.value,
        unit_cost: itemForm.unit_cost.value,
        checked_at: itemForm.checked_at.value || null,
      });
      itemForm.reset();
      delete itemForm.dataset.editingId;
      syncChildOptions(itemRootLab.value, itemChildLab, false);
      showToast("저장됨");
    });

    [subLab, onlyLow, search].forEach(el => {
      el.addEventListener("input", () => { applyFilters(); renderTable(); });
      el.addEventListener("change", () => { applyFilters(); renderTable(); });
    });

    // 12) CSV/텍스트 도구
    const importCsvBtn = $("#importCsvBtn");
    const importCsvInput = $("#importCsvInput");
    const exportCsvBtn = $("#exportCsvBtn");
    const copyTextBtn = $("#copyTextBtn");

    importCsvBtn.addEventListener("click", () => importCsvInput.click());
    importCsvInput.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const text = await file.text();
      const lines = text.trim().split(/\r?\n/);
      const header = lines.shift()?.split(",");
      const idx = (h) => header.findIndex(x => x.trim() === h);
      for (const line of lines) {
        const cells = line.split(",");
        await upsertItem({
          name: cells[idx("name")] || "",
          group: cells[idx("group")] || "",
          lab: cells[idx("lab")] || "",
          location: cells[idx("location")] || "",
          qty: cells[idx("qty")] || 0,
          unit_cost: cells[idx("unit_cost")] || 0,
          checked_at: cells[idx("checked_at")] || null,
        });
      }
      showToast("CSV 가져오기 완료");
      importCsvInput.value = "";
    });

    exportCsvBtn.addEventListener("click", () => {
      const header = "name,group,lab,location,qty,unit_cost,checked_at";
      const rows = state.view.map(v => [
        (v.name||""),
        (v.group||""),
        (v.lab||""),
        (v.location||""),
        Number(v.qty||0),
        Number(v.unit_cost||0),
        (v.checked_at||"")
      ].join(","));
      const blob = new Blob([ [header, ...rows].join("\n") ], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "inventory.csv"; a.click();
      URL.revokeObjectURL(url);
    });

    copyTextBtn.addEventListener("click", async () => {
      const lines = state.view.map(v =>
        `품목명:${v.name||""} | 상위:${v.group||""} | 하위:${v.lab||""} | 위치:${v.location||""} | 현재고:${Number(v.qty||0)} | 단가:${Number(v.unit_cost||0)} | 날짜:${v.checked_at||""}`
      );
      const text = lines.join("\n");
      try {
        await navigator.clipboard.writeText(text);
        showToast("텍스트 복사됨");
      } catch {
        const ta = document.createElement("textarea");
        ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove();
        showToast("텍스트 복사됨");
      }
    });

    // 13) 온라인/오프라인 UX
    window.addEventListener("online", () => showToast("온라인 - 동기화됨"));
    window.addEventListener("offline", () => showToast("오프라인 - 로컬 작업 대기"));

    // 14) 초기화
    document.addEventListener("DOMContentLoaded", () => {
      // 초기 필터 하위Lab 옵션은 상위가 공백이면 전체만
      if (!topGroup.value) {
        subLab.innerHTML = "";
        const o = document.createElement("option");
        o.value = ""; o.textContent = "전체"; subLab.appendChild(o);
      } else {
        syncChildOptions(topGroup.value, subLab, true);
      }
      startLiveSubscription();
      showToast("실시간 동기화 시작");
    });
  </script>
</body>
</html>